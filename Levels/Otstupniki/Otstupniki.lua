----------------------------------------------------------------------------
--
-- Description :  Mission "Otstupniki"
--
--
----------------------------------------------------------------------------

-- Tasks:

------------------------------------ completed ------------ deadline ------------ completed ---------
-- NULL ITTERATION:           |                      |                       |                      |
-- additional models:         |                      |                       |                      |
-- update bad house models    |    100%              |                       |   24.12.2007         |
-- market models              |     50%              |                       |                      |
-- pipe for boat              |    100%              |                       |   24.12.2007         |
-- lock for bathdoor          |    100%              |                       |   28.12.2007         |
-- pipe for boards            |    100%              |                       |   27.12.2007         |
-- vedro                      |    100%              |                       |   27.12.2007         |
----------------------------------------------------------------------------------------------------|
-- FIRST ITTERATION:                                                                                |
-- documentation              |    100%     |  serg  |    17.12.2007         |   18.12.2007         |
-- vector map                 |    100%     |  dim   |    15.12.2007         |   15.12.2007         |
-- indoor waypoints           |    100%     |  dim   |    15.12.2007         |   17.12.2007         |
-- waypoints                  |    100%     |  serg  |    15.12.2007         |   17.12.2007         |
-- firepoints                 |<n> 100%     |  serg  |    15.12.2007         |   15.12.2007         |
-- stairs                     |    100%     |  serg  |    15.12.2007         |   15.12.2007         |
-- grenade holes              |<n> 100%     |  serg  |    15.12.2007         |   15.12.2007         |
-- lma triggers               |    100%     |  dim   |    17.12.2007         |   17.12.2007         |
-- invisible wall             |    100%     |  dim   |    17.12.2007         |   17.12.2007         |

-- active level state: west serg wp, east dim
-- market construction        |    100%     |  dim   |    19.12.2007 <prot>  |   19.12.2007         |
-- building construction      |    100%     |  dim   |    19.12.2007         |   19.12.2007         |
-- start script               |    100%     |  serg  |    19.12.2007         |   19.12.2007         |
-- shadowing script           |    100%     |  serg  |    19.12.2007         |   20.12.2007         |
-- bridge mine script         |    100%     |  serg  |    19.12.2007         |   20.12.2007         |
-- spy cutscene               |    100%     |  serg  |    19.12.2007         |   19.12.2007         |

-- patrol script & smersh doc |    100%     |  serg  |    20.12.2007 <reser> |   20.12.2007         |
-- officer lecture scene      |    100%     |  serg  |    20.12.2007         |   22.12.2007         |
-- fix waypoints              |    100%     |  di/s  |    20.12.2007         |   21.12.2007         |

-- synchronize level:         |    100%     |  serg  |    21.12.2007         |   21.12.2007         |
-- active level state: dim. only brushes
-- diversant1 idle            |    100%     |  serg  |    21.12.2007         |   25.12.2007         |
-- lg south-east              |    100%     |  serg  |    21.12.2007         |   24.12.2007         |
-- constr house scene         |    100%     |  serg  |    21.12.2007         |   21.12.2007         |
-- training scene             |    100%     |  serg  |    21.12.2007         |   22.12.2007         |
-- main house                 |    100%     |  serg  |    21.12.2007         |   22.12.2007         |
-- lg south-west              |    100%     |  serg  |    21.12.2007         |   21.12.2007         |
-- additional npc flags       |    100%     |  serg  |    21.12.2007 <a>     |   21.12.2007         |

-- physics                    |    100%     |  dim   |    22.12.2007         |   22.12.2007         |
-- boxes scene                |    100%     |  serg  |    22.12.2007         |   21.12.2007         |
-- market scene               |    100%     |  serg  |    22.12.2007         |   24.12.2007         |
-- soldier group job          |    100%     |  serg  |    22.12.2007         |   21.12.2007         |
-- synchronize level:         |    100%     |  serg  |    22.12.2007         |   22.12.2007         |
-- active level state: serg

-- windows                    |    100%     |  dim   |    24.12.2007         |   24.12.2007         |
-- expl objects               |    100%     |  dim   |    24.12.2007         |   24.12.2007         |
-- doors                      |    100%     |  serg  |    24.12.2007         |   25.12.2007         |
-- diversant2 idle            |    100%     |  serg  |    24.12.2007         |   25.12.2007         |
-- lg north-west              |    100%     |  serg  |    24.12.2007         |   27.12.2007         |
-- diversant3 idle            |    100%     |  serg  |    24.12.2007         |   27.12.2007         |
-- lg north-east              |    100%     |  serg  |    24.12.2007         |   27.12.2007         |
-- patrols                    |    100%     |  serg  |    24.12.2007         |   25.12.2007         |

-- additional local gameplay  |    100%     |  dim   |    25.12.2007         |   27.12.2007         |
-- order soldiers script      |    100%     |  serg  |    25.12.2007         |   27.12.2007         |
-- spy order scene            |    100%     |  serg  |    25.12.2007         |   25.12.2007         |
-- smersh doc diversant reac  |   <susp>    |  serg  |    25.12.2007         |   05.01.2008         |
-- hello officer triggers     |    100%     |  serg  |    25.12.2007         |   27.12.2007         |
-- drinking scene             |    100%     |  serg  |    25.12.2007         |   25.12.2007         |
-- drinking soldiers scene    |    100%     |  serg  |    25.12.2007         |   25.12.2007         |
-- spy enter house scene      |    100%     |  serg  |    25.12.2007         |   27.12.2007         |

-- doctor call script         |    100%     |  serg  |    26.12.2007         |   27.12.2007         |
-- boat script                |    100%     |  serg  |    26.12.2007         |   26.12.2007         |
-- board script               |    100%     |  serg  |    26.12.2007         |   26.12.2007         |
-- paint script               |    100%     |  serg  |    26.12.2007         |   26.12.2007         |
-- bath lock script           |    100%     |  serg  |    26.12.2007         |   26.12.2007         |
-- dynamic cutscene           |    100%     |  serg  |    26.12.2007         |   05.01.2008         |
-- dialogs                    |    100%     |  dim   |    26.12.2007 <a>     |   27.12.2007         |

-- npc postprocess            |    100%     |  serg  |    27.12.2007         |   28.12.2007         |
-- zone system                |    100%     |  serg  |    27.12.2007         |   28.12.2007         |
-- keys                       |    100%     |  serg  |    27.12.2007         |   28.12.2007         |
-- stop move messages         |    100%     |  serg  |    27.12.2007         |   28.12.2007         |
-- potential physics test     |    100%     |  serg  |    27.12.2007         |   28.12.2007         |
-- safe ai methods            |    100%     |  serg  |    27.12.2007         |   28.12.2007         |
-- voices list                |    100%     |  serg  |    27.12.2007 <a>     |   28.12.2007         |

-- bridge unmine script       |    100%     |  serg  |    28.12.2007         |   29.12.2007         |
-- tasks                      |    100%     |  serg  |    28.12.2007         |   29.12.2007         |
-- marks                      |    100%     |  serg  |    28.12.2007         |   29.12.2007         |
-- alert setup                |    100%     |  serg  |    28.12.2007         |   28.12.2007         |
-- alert scripts              |    100%     |  serg  |    28.12.2007         |   28.12.2007         |

-- physics sov. vehicle       |    100%     |  serg  |    29.12.2007         |   05.01.2008         |
-- I it. gameplay test        |    100%     |  serg  |    29.12.2007         |   03.01.2008         |
-- briefing map               |    100%     |  warh  |        <?>            |   04.01.2008         |
-- grass vision map           |      0%     |  serg  |        <?>            |                      |
-- waypoint vision level      |      0%     |  serg  |        <?>            |                      |
-- 
-- lighting                   |      0%     |  warh  |        <?>            |                      |
-- mirrors                    |      0%     |  warh  |        <?>            |                      |
-- effects                    |      0%     |  warh  |        <?>            |                      |
-- help messages              |      0%     |  dim   |        <?>            |                      |
-----------------------------------------------------------------------------------------------------
-- SECOND ITTERATION:
-----------------------------------------------------------------------------------------------------
-- npc visual post process    |      0%     |  serg  |        <?>            |   05.01.2008         |
-----------------------------------------------------------------------------------------------------

-- test:
-- + shestakov boat script

-- bugs:
-- + Lock all vehicles to protect start script!
-- Strong anchor use idle's to protect start script!
-- Basenpc hmm auto corrector, teleport bot to anchor if it is in grond
-- Add undergroup invisible walls
-- + Potential see dont change attention flag
-- + Stone don't change attention flag

--------------------------------- Messages table -----------------------------


-- Voice Message table:
-- ×òî çà ÷åðòîâùèíà òàì òâîðèòñÿ?
-- ×óâñòâóþ ýòó äóðó ïðèäåòñÿ òàùèòü îòñþäà... (ñàìîëåòó)
-- Âïåðåä
-- Ñóäÿ ïî êàðòå íà âåðøèíå õîëìà îíè íàñ æäóò
-- Ìàøèíà ñäîõëà. Äàëüøå ïåøêîì
-- Ðÿäîâîé Èâàíîâ ïðèáûë
-- Æàëîáû åñòü?
-- Íèêàê íåò. Ðàçðåøèòå èäòè
-- Ðÿäîâîé! Êî ìíå! 
-- Åñòü! Ðÿäîâîé Äåâàäçå Ïðèáûë!
-- Òû ÷åãî ñîâñåì îäóðåë?! Â òàêîì âèäå â ñòðîþ ïîÿâëÿòñÿ! Çà íåáðèòóþ ôèçèîíîìèþ íàðÿä âíå î÷åðåäè!
-- Åñòü íàðÿä!
-- È ðàç! 
-- Òüôó, ëàäíî ïîåõàëè.
-- Ñèãàðåò íå íàéäåòñÿ?
-- Ó âàñ ñâîáîäíî. Ïàðó äíåé ïåðåíî÷åâàòü ñìîãó?
-- Óãó
-- Çäðàâèå æåëàþ! Òîâàðèù ñòàðøèé ëåéòåíàíò!
-- ×òî çà ÷åðò! ß çà äîêòîðîì!
-- Òîâàðèù êàïèòàí... Ðàçðåøèòå èäòè?
-- Äîêòîð! Òàì áîéöó íà ãîëîâó ëîäêà óïàëà!
-- Äîêòîð! Òàì áîéöó íà ãîëîâó äîñêè óïàëè!
-- Æèâ. Âðîäå âñå â ïîðÿäêå.
-- Çäðàâèÿ æåëàþ òîâàðèù ìàéîð
-- Çäðàâèÿ æåëàþ òîâàðèù êàïèòàí

-- alert groups:
-- 0 - main house
-- 1 - worker soldiers & south soldiers
-- 2 - south-west soldiers
-- 3 - north
-- 4 - market alert group
-- 5 - bridge soldiers
-- 6 - south group
-- 10 - diversants

  
  MissionText = 
  {
      Message_CutScene_SpyInvite       = "- Ïîêà âñå ïî ïëàíó. Ìû ãîòîâû âûïîëíèòü çàäà÷ó. Òóò äåòàëè.";
      Message_CutScene_SpyRespond      = "- Îòëè÷íî. Ïðîäîëæàéòå îïåðàöèþ. Ìû âûäâèãàåìñÿ â ïîñåëîê.";
      Message_CutScene_Docs            = "- Ïðåäúÿâèòå âàøè äîêóìåíòû!";
      Message_CutScene_Binocular       = "- Îõðàíû ïîêà íåò. Ìîæåì íà÷èíàòü";
      
      Message_ShowMePass               = "@ Ïðåäúÿâèòå âàøè äîêóìåíòû!";
      Message_Fire                     = "@ Åùå îäèí øàã è ÿ îòêðûâàþ îãîíü!";
      Message_OkWeWillGo               = "@ Òàê òî÷íî! Ìû ïîðàáîòàåì ïîêà â äðóãîì ìåñòå";
      
      Message_DocsClear                = "@ Òîâàðèù êàïèòàí... Ðàçðåøèòå èäòè?";
      Message_ForDoctor                = "@ ×òî çà ÷åðò! ß çà äîêòîðîì!";
      Message_Binocular                = "@ Îõðàíû ïîêà íåò. Ìîæåì íà÷èíàòü..";
      
      Message_ShowDocs                 = "ÏÎÊÀÇÀÒÜ ÓÄÎÑÒÎÂÅÐÅÍÈÅ";
      Message_ShowCaptainDocs          = "ÏÎÊÀÇÀÒÜ ÓÄÎÑÒÎÂÅÐÅÍÈÅ";
      
      Message_DocsName                 = "Óäîñòîâåðåíèå ÑÌÅÐØ";
      Message_DocsNameL                = "ÓÄÎÑÒÎÂÅÐÅÍÈÅ ÑÌÅÐØ";
      
      Message_FormInfo                 = "! Â êàìóôëÿæíîé ôîðìå ìîæíî ìàñêèðîâàòüñÿ â òðàâå..";
      
      Action_CutRopeBrevna             = "ÏÅÐÅÐÅÇÀÒÜ ÂÅÐÅÂÊÓ";
      Action_CutRopeBoat               = "ÏÅÐÅÐÅÇÀÒÜ ÂÅÐÅÂÊÓ";
      Action_DropBucket                = "ÒÎËÊÍÓÒÜ ÂÅÄÐÎ";
      Action_CloseDoor                 = "ÇÀÏÅÐÅÒÜ ÄÂÅÐÜ";
      Action_Demine                    = "ÐÀÇÌÈÍÈÐÎÂÀÒÜ";
      Action_UseRadio                  = "ÈÑÏÎËÜÇÎÂÀÒÜ ÐÀÖÈÞ";
      
      Failed_See                       = "ÎÏÅÐÀÖÈß ÑÎÐÂÀÍÀ! ÂÀÑ ÎÁÍÀÐÓÆÈËÈ!";
      Failed_Body                      = "ÎÏÅÐÀÖÈß ÑÎÐÂÀÍÀ! ÐÀÇÂÅÄÃÐÓÏÏÎÉ ÎÁÍÀÐÓÆÅÍÎ ÒÅËÎ ÄÈÂÅÐÑÀÍÒÀ";
      Failed_Attention                 = "ÎÏÅÐÀÖÈß ÑÎÐÂÀÍÀ! ÐÀÇÂÅÄÃÐÓÏÏÀ ×ÒÎ-ÒÎ ÇÀÏÎÄÎÇÐÈËÀ";
      Failed_Kill                      = "ÎÏÅÐÀÖÈß ÑÎÐÂÀÍÀ! ÂÑÒÐÅ×À ÍÅ ÑÎÑÒÎßËÀÑÜ";
      Failed_KillGroup2                = "ÎÏÅÐÀÖÈß ÏÐÎÂÀËÅÍÀ! ÍÅËÜÇß ÑÐÛÂÀÒÜ ÐÀÇÐÀÁÎÒÊÓ ÝÒÎÉ ÃÐÓÏÏÛ";
      Failed_Alert                     = "ÎÏÅÐÀÖÈß ÑÎÐÂÀÍÀ! ÏÎÄÍßÒÀ ÒÐÅÂÎÃÀ";
      Failed_AlertDiver                = "ÎÏÅÐÀÖÈß ÑÎÐÂÀÍÀ! ÂÀØÅ ÏÐÈÑÓÒÑÒÂÈÅ ÐÀÑÊÐÛÒÎ";
      Failed_SovietKilled              = "ÓÁÈÒ ÑÎÂÅÒÑÊÈÉ ×ÅËÎÂÅÊ";
      Failed_StarikovDead              = "ÑÒÀÐÈÊÎÂ ÄÎËÆÅÍ ÎÑÒÀÒÜÑß ÆÈÂ";

      Message_StopMove_WeaponHouseNear = "@ Ñòîé! Ñòðåëÿòü áóäó!";
      Message_StopMove_MainHouseNear   = "@ ß íå ìîãó ïðîïóñòèòü âàñ ñþäà!";
      Message_StopMove_MainHouse       = "@ Ïîêèíüòå ïîìåùåíèå íåìåäëåííî!";
      Message_StopMove_Const_Officer   = "@ Òîâàðèù êàïèòàí - òóò îïàñíî!";
      Message_StopMove_Const_Major     = "@ Òîâàðèù ìàéîð - òóò îïàñíî!";
      Message_StopMove_Const           = "@ Âàì íå ñòîèò òóò íàõîäèòüñÿ!";
      
      Task_Diversion                   = "Ïðåäîòâðàòèòü äèâåðñèþ";
      Task_Meet                        = "Ïðîñëåäèòü çà ãðóïïîé";
      Task_Nikolaev                    = "Çàõâàòèòü Íèêîëàåâà";
      Task_Shestakov                   = "Çàõâàòèòü Øåñòàêîâà";
      Task_Starikov                    = "Çàõâàòèòü Ñòàðèêîâà";
      Task_Radio                       = "Ñîîáùèòü â öåíòð";
      
      Message_PlanName                 = "Ïëàí äèâåðñèè";
      Message_PlanNameL                = "ÏËÀÍ ÄÈÂÅÐÑÈÈ";
      
      Message_TaskChanged              = "Çàäàíèÿ èçìåíåíû";
  };
  
  MissionSamples = 
  {
      Sample_ShowMePass = "",
      Sample_Fire       = "",
      Sample_OkWeWillGo = "",
      Sample_ForDoctor  = ""
  };

------------------------ Initialization and save/load ------------------------

--------------------------------------------------------
-- Name: Level.OnCompleteMission()
-- Desc:
--------------------------------------------------------
function Level.OnCompleteMission()

      System:ConsoleCommand( 'l_loadlevel "gamemenu" 1' ); -- forlik

end;

--------------------------------------------------------
-- Name: Level.OnFinishLoad()
-- Desc:
--------------------------------------------------------
  function Level.OnFinishLoad()
  
       Level.OnFinishLoad_Common();
       
       if (Level.SaunaDoorLocked == true) then
          local door = Level.FindDoor('SNDR');
          if (door != nil) then
             Level.SetDoorUnlockKey(door, "deadlock");
             AI.RegisterClosedDoor( door, true );
          end          
          Level.SetWorldObjectAnimFrame( Level.FindWorldObject('SNDR'), 30.0 );
       end
       
       Level.SetDOFPostFilter( 1, 0.0, 1500.0, 2700.0 );
       
       System:SetVar( "r_dofsky", 128 );
       System:SetVar( "r_rimsunlightfactor", 0.175 );
       System:SetVar( "r_farclip" , 3000.0 );
       
       Level.EnableObjectHitNotify('ROPE', true );
       Level.EnableObjectHitNotify('ROP2', true );
       
       Level.AddMusic( Level.MUSIC_MOOD_DEFAULT  , "#0.4#sounds\\music\\ambiento.ogg" );
       Level.AddMusic( Level.MUSIC_MOOD_ACTION   , "#0.75#sounds\\music\\sustain.ogg" );       
       Level.AddMusic( Level.MUSIC_MOOD_ATTENTION, "#0.75#sounds\\music\\sustain.ogg" );       
       
       Level.SetDefaultMusicPause( 100.0, 180.0, 30.0, 120.0 );
       
       Level.RegisterWorldArea( "WaterSkip" , 332.5781,-131.5637,-1741.9276,4701.2344,337.4316,1342.1012 );
  end;

--------------------------------------------------------
-- Name: Level.OnSave()
-- Desc:
--------------------------------------------------------
  function Level.OnSave()
       Stream.WriteInt(2);
       
       Stream.WriteInt (Level.GlobalState);
       Level.WriteArray( Level.GlobalScenaryNpc );
       
       Level.WriteArray( Level.SynchroAnchor );
       
       Stream.WriteBool( Level.SpyDialogCompleted );
       Stream.WriteBool( Level.PlayerNearHouse );
       
       Level.WriteArray( Level.SpySynchroAnchor );
       Level.WriteArray( Level.SpyNpc );
       Stream.WriteInt ( Level.SpyState );

       Stream.WriteString( Level.PassState );
       Stream.WriteBool  ( Level.PatrolPassShowed );
       
       Level.WriteArray( Level.PatrolMan );
       Stream.WriteString( Level.ToDoctorNpc );
       Stream.WriteInt( Level.DinnerMan );
       
       Stream.WriteBool( Level.PlayerNearHouseDisabled );
       Stream.WriteBool( Level.BrevnaRopeCutted        );
       Stream.WriteBool( Level.BoatRopeCutted          );
       Stream.WriteBool( Level.SpyAtSauna              );
       
       Stream.WriteBool( Level.SaunaDoorLocked );
       Stream.WriteString( Level.SaunaSpyNpcId );
       
       Stream.WriteBool( Level.CaptainDocsScriptCompleted );
       
       Level.WriteArray( Level.InvestigatedAccident );
       Level.WriteArray( Level.DoctorAccidentAnchor );
       Stream.WriteString( Level.RunForDoctorNpcId );
       
       Level.WriteArray( Level.Vehicles );
       Level.WriteArray( Level.DynamiteFusedState );
       
       Stream.WriteBool( Level.PlayerNearBridge );
       Stream.WriteBool( Level.NearStartPoint );
       
       Level.WriteArray(Level.PlayerDecamouflageState);
       Level.WriteArray(Level.LockVisionNotify);
       
       Stream.WriteBool( Level.VedroScriptDone );
       
       -- version 1
       Stream.WriteBool( Level.WasPlayerNearHouse );
       
       -- version 2
       Stream.WriteBool( Level.BoatRopeBulletHitted   );
       Stream.WriteBool( Level.BrevnaRopeBulletHitted );
       
       Level.OnSave_Common();              
  end

--------------------------------------------------------
-- Name: Level.OnLoad()
-- Desc:
--------------------------------------------------------
  function Level.OnLoad()
  
       local version                    = Stream.ReadInt();
       
       Level.GlobalState                = Stream.ReadInt();
       Level.GlobalScenaryNpc           = Level.ReadArray();
       
       Level.SynchroAnchor              = Level.ReadArray();

       Level.SpyDialogCompleted         = Stream.ReadBool();
       Level.PlayerNearHouse            = Stream.ReadBool();

       Level.SpySynchroAnchor           = Level.ReadArray();
       Level.SpyNpc                     = Level.ReadArray();
       Level.SpyState                   = Stream.ReadInt();

       Level.PassState                  = Stream.ReadString();
       Level.PatrolPassShowed           = Stream.ReadBool();
        
       Level.PatrolMan                  = Level.ReadArray();
       Level.ToDoctorNpc                = Stream.ReadString();
       Level.DinnerMan                  = Stream.ReadInt();
       
       Level.PlayerNearHouseDisabled    = Stream.ReadBool();
       Level.BrevnaRopeCutted           = Stream.ReadBool();
       Level.BoatRopeCutted             = Stream.ReadBool();
       Level.SpyAtSauna                 = Stream.ReadBool();
       
       Level.SaunaDoorLocked            = Stream.ReadBool();
       Level.SaunaSpyNpcId              = Stream.ReadString();
       
       Level.CaptainDocsScriptCompleted = Stream.ReadBool();
       
       Level.InvestigatedAccident       = Level.ReadArray();
       Level.DoctorAccidentAnchor       = Level.ReadArray();
       Level.RunForDoctorNpcId          = Stream.ReadString();
       
       Level.Vehicles                   = Level.ReadArray();
       Level.DynamiteFusedState         = Level.ReadArray();
       
       Level.PlayerNearBridge           = Stream.ReadBool();
       Level.NearStartPoint             = Stream.ReadBool();

       Level.PlayerDecamouflageState    = Level.ReadArray();
       Level.LockVisionNotify           = Level.ReadArray();
       
       Level.VedroScriptDone            = Stream.ReadBool();
       
       Level.WasPlayerNearHouse         = true;
       Level.BoatRopeBulletHitted       = false;
       Level.BrevnaRopeBulletHitted     = false;
       
       if (version >= 1) then
          Level.WasPlayerNearHouse = Stream.ReadBool();
       end
       
       if (version >= 2) then
          Level.BoatRopeBulletHitted   = Stream.ReadBool();
          Level.BrevnaRopeBulletHitted = Stream.ReadBool();
       end       

       Level.OnLoad_Common();                                   
       Level.OnFinishLoad();
  end

--------------------------------------------------------
-- Name: Level.OnLoaded()
-- Desc:
--------------------------------------------------------
  function Level.OnLoaded()

       -- Install varibles..
       Level.OnLoaded_Common();

       Level.PlayerAnimSounds={};
       
       Level.GlobalState = 0;
       Level.SpyState    = 0;
       Level.GlobalScenaryNpc = { 'STAR', 'NIKO', 'SHES' };
       Level.SpyNpc           = { 'SPY1', 'SPY2' };
       Level.PatrolMan        = { 'PTR1', 'PTR2', 'PTR3' };
       
       Level.SoundName        = { "tik_1", "tik_2", "tik_3", "tik_4" };                          
       Level.SoundState       = { false , false, false, false };
       
       Level.SynchroAnchor    = {};
       Level.SpySynchroAnchor = {};
       
       Level.SpyDialogCompleted = false;
       Level.PlayerNearHouse    = false;
       
       Level.PassState          = "";
       Level.PatrolPassShowed   = false;
       
       Level.ToDoctorNpc        = "";
       Level.DinnerMan          = 0;
       
       Level.PlayerNearHouseDisabled = false;

       Level.BrevnaRopeCutted = false;
       Level.BoatRopeCutted   = false;
       
       Level.SpyAtSauna       = false;
       Level.SaunaDoorLocked  = false;
       
       Level.Vehicles         = { 'ZS05', 'KB02', 'ZS04', 'ZS06', 'KB03', 'ZS01', 'GS02' };
       
       Level.DynamiteFusedState = {};
       Level.DynamiteFusedState['DYN1'] = "nofused";
       Level.DynamiteFusedState['DYN2'] = "nofused";
       Level.DynamiteFusedState['DYN3'] = "nofused";
       Level.DynamiteFusedState['DYN4'] = "nofused";
       
       --Level.SaunaSpyNpcId = 'TEST';
       Level.SaunaSpyNpcId = 'SHES';
       
       Level.CaptainDocsScriptCompleted = false;
       
       Level.DoctorAccidentAnchor = {};
       Level.DoctorAccidentAnchor['SHES'] = 'A270';
       Level.DoctorAccidentAnchor['NIKO'] = 'A271';
       --Level.DoctorAccidentAnchor['TES2'] = 'A270';       
       --Level.DoctorAccidentAnchor['TST3'] = 'A271';
       
       Level.InvestigatedAccident = {};
       
       Level.RunForDoctorNpcId = "";
       
       Level.PlayerNearBridge   = false;
       Level.NearStartPoint     = false;
       Level.WasPlayerNearHouse = false;
       
       Level.PlayerDecamouflageState = {};
       Level.LockVisionNotify = {};
       for i in Level.GlobalScenaryNpc do
          Level.PlayerDecamouflageState[Level.GlobalScenaryNpc[i]] = 0;
          Level.LockVisionNotify[Level.GlobalScenaryNpc[i]] = false;
       end
       
       Level.VedroScriptDone = false;
       
       Level.BoatRopeBulletHitted   = false;
       Level.BrevnaRopeBulletHitted = false;
       
       -- Action handlers..
       
       Level.AddActionHandler( Level.AH_ACTOR_KILLED, Level.SaunaSpyNpcId, "OnKillShestakov");
       Level.AddActionHandler( Level.AH_ACTOR_HITTED, Level.SaunaSpyNpcId, "OnHitShestakov");

       Level.AddActionHandler( Level.AH_ACTOR_KILLED, 'NIKO', "OnKillNikolaev");
       Level.AddActionHandler( Level.AH_ACTOR_HITTED, 'NIKO', "OnHitNikolaev");

       Level.AddActionHandler( Level.AH_ACTOR_KILLED, 'STAR', "OnKillStarikov");
       Level.AddActionHandler( Level.AH_ACTOR_HITTED, 'STAR', "OnHitStarikov");
       
       for i in Level.SpyNpc do 
          Level.AddActionHandler( Level.AH_ACTOR_KILLED, Level.SpyNpc[i], "OnNeut_Group2");
          Level.AddActionHandler( Level.AH_ACTOR_HITTED, Level.SpyNpc[i], "OnNeut_Group2");
       end
       
       for i in Level.GlobalScenaryNpc do 
          Level.AddActionHandler( Level.AH_SEE_PLAYER, Level.GlobalScenaryNpc[i], "OnSeePlayer_Group1" );
          
          Level.AddActionHandler( Level.AH_ACTOR_BODY_INFO, Level.GlobalScenaryNpc[i], "OnGroup1_BodyInfo_" .. Level.GlobalScenaryNpc[i] );
       end
       
       for i in Level.SpyNpc do
          Level.AddActionHandler( Level.AH_SEE_PLAYER, Level.SpyNpc[i], "OnSeePlayer_Group2" );
       end
       
       Level.AddActionHandler( Level.AH_CHANGE_CLOTH );
       Level.AddActionHandler( Level.AH_PLAYER_INVENTORY );
              
       Level.AddActionHandler( Level.AH_ACTOR_ALL_KILLED );
       
       Level.AddActionHandler( Level.AH_FINISH_CHANGECLOTH, 'WO02', "OnChangeCloth_Officer" );
       Level.AddActionHandler( Level.AH_FINISH_CHANGECLOTH, 'WS01', "OnChangeCloth_Soldier" );
       Level.AddActionHandler( Level.AH_FINISH_CHANGECLOTH, 'WS02', "OnChangeCloth_Soldier" );
       Level.AddActionHandler( Level.AH_FINISH_CHANGECLOTH, 'WS03', "OnChangeCloth_Soldier" );
       Level.AddActionHandler( Level.AH_FINISH_CHANGECLOTH, 'WD01', "OnChangeCloth_Ded" );
       Level.AddActionHandler( Level.AH_FINISH_CHANGECLOTH, 'WD02', "OnChangeCloth_Ded" );
       
       
       -- Init player..
       local player     = Level.FindActor('PLYR');
       
       if ( player != nil ) then

          if ( Level.HasPlayerEquipPack() == false ) then
          
             local pistol     = Level.CreateItem("HiStandart","Weapon");
             local knife      = Level.CreateItem("KnifeNR43","Weapon");
 
             Actor.PutWeapon( player, Actor.WEAPON_SLOT_PISTOL , pistol );
             Actor.PutWeapon( player, Actor.WEAPON_SLOT_KNIFE, knife );

             Actor.PutWeaponAmmo( player, "HiStandart");
             Actor.PutEmptyPouch( player, "fiberwire", "Weapon" );                          
             Actor.PutEmptyPouch( player, "lockpick", "Equipment" );             
             Actor.PutEmptyPouch( player, "chloroform", "Weapon" );
                                       
             Actor.PutEmptyPouch( player, "binocular", "Equipment" );
                                       
             local pack = Level.CreateItem( "playersack", "container" );
             if ( pack == nil ) 
             then
                error('Failed create player pack');
             end;
                          
             Actor.PutBackPack( player, pack );
          end;
          
          -- Smersh docs..
          
          local pass = Level.CreateItem( "Custom" , "Equipment" );   
          if ( pass != nil ) then
          
            Entity.SetUniqueID( pass, 'PASS' );
            
            Level.SetCustomItemIcon( pass, "ammo_doc" );
            Level.SetCustomItemName( pass, MissionText.Message_DocsName );
            
            local emptyPouch = Actor.GetEmptyPouch( player );
            if ( emptyPouch < 0 ) then
                emptyPouch = 17;
            end;
             
            Actor.PutPouch( player, emptyPouch, pass );
          end;

          local form = Level.FindItem( 'WRSO' );
          if (form != nil) then
            AI.RegisterWearForm( form, "Officer" );          
          end;

          Actor.ChangeActorSkin( Level.GetPlayer(), "Summer" );
          Level.ChangePlayerStand( 2 );
       end;       

       Level.AddActionHandler( Level.AH_FINISH_CHANGECLOTH, 'WRSO', "OnChangeCloth_Officer" );
       
       -- Entities..
       
       local dynamites = { 'DYN1', 'DYN2', 'DYN3', 'DYN4' };
       for i in dynamites do
          local dynamite = Level.FindWeaponItem( dynamites[i] );
          if (dynamite != nil) then
             Level.EnableItemPickup( dynamite, false );
             Entity.SetHidden( dynamite, true );
          else
             print("Error: Can't find dynamite " .. dynamites[i] );
          end
       end
       
       local boxes = { 'WB12', 'WB13', 'WB09', 'WB14', 'WB10', 'WB15', 'WB11' };
       for i in boxes do
          local box = Level.FindItem( boxes[i] );
          if (box != nil) then
             Level.EnableItemPickup( box, false );
          end
       end
       
       Level.HideWorldObject('VDR2');
       
       Level.DisableVehicles( true );   
       
     
       -- Keys..
       
       -- Init mission tasks..
       Level.InstallInitialTasks();

       -- AI..
       AI.ForEachNpc("ChangeSoldierLogic", "form", "Soldier");
       AI.ForEachNpc("ChangeSoldierLogic", "form", "SoldierWorker");
       AI.ForEachNpc("ChangeSoldierLogic", "form", "Soldier_ID");
       
       Level.SetHiGitlerAnim( "Act_Stand_ArmyHi", 5.0 );
       
       Level.RunAnchorJob3_Run( AI.FindNPC('NIKO'), 'AN03', 'AN04', 'AN09', true );

       for i in Level.SpyNpc do
          local npc = AI.FindNPC(Level.SpyNpc[i]);
          
          --AI.ChangeLogic(npc, "ScriptEnemy");
          
          AI.Disable(npc, "stone_change_attention");
          AI.Disable(npc, "part_see_change_attention");
          AI.Disable(npc, "stone_reaction");
          
          AI.Enable(npc, "notify_attention_change");
          AI.Enable(npc, "threat_as_know_player");
       end
       
       for i in Level.GlobalScenaryNpc do
          local npc = AI.FindNPC(Level.GlobalScenaryNpc[i]);
          
          AI.ChangeLogic(npc, "Diversant");
          
          AI.Disable(npc, "stone_change_attention");
          AI.Disable(npc, "part_see_change_attention");
          AI.Disable(npc, "stone_reaction");
          
          AI.Enable(npc, "notify_attention_change");
       end
       
       AI.Enable("notify_see_body");
		
       if (AI.FindNPC('SS85') != nil) then
         local properties = {};
         
         properties["DistanceRun"]    = true;
         properties["ParentPolicy"]   = true;
         properties["WatchCommander"] = true;
         properties["TurnCommander"]  = true;
         properties["RaisedWeapon"]   = false;
       
         AI.FollowActor( AI.FindNPC('SS85'), 
                         AI.GetActor(AI.FindNPC('SO15')), 
                         -10.0, 
                         -15.0, 
                         Level.ToCustomParams(properties));
       end
       
       Level.DoFollow('SS91', 'PTR1');
       Level.DoFollow('SS92', 'PTR1', {x = 10.0, z = -25.0} );
       Level.DoFollow('SS94', 'PTR2');
       Level.DoFollow('SS96', 'PTR3');
       
       AI.Disable(AI.FindNPC('WS08'), "stone_change_attention");
       AI.Disable("investigate_accident_body");
       AI.Disable("surrender");
       -- AI.Enable("simple_fight");
       AI.Enable("pacific_fight");
       AI.Disable("synchronize_accident_body_attention");
       
       AI.SetPlayerForm("Diversant");
       AI.SetPlayerDefaultForm("Diversant");
       
       -- AI.OnPlayerEnterZone("StartZone", 'STZN');
       AI.OnPlayerEnterZone("global", 'GLBL');
       AI.OnPlayerEnterZone("global_2", 'GL2L');
       AI.OnPlayerEnterZone("BeforeVillage_Global", 'BFGL');
       AI.OnPlayerEnterZone("patrols", 'PTRL');
       
       AI.SetPlayerCamouflageState( true );
       
       for i in Level.GlobalScenaryNpc do
         AI.DecamouflagePlayer( AI.FindNPC(Level.GlobalScenaryNpc[i]), false );
       end
       
       Level.NextDoctorNpc();
       
       AI.AddScriptDynamicObstacle( 'FCDR', -1203.9578, -39.6111, -2656.9395, -1197.2693, -15.2586, -2642.4790 );       
       
       AI.AddBlockVisionBox(858.6307, -41.5875, 114.7598, 860.1417, -29.7565, 138.2308);
       
       if (AI.FindNPC('TST3') != nil) then
          AI.ChangeLogic(AI.FindNPC('TST3'), "Diversant");
       end
       
       AI.ChangeLogic(AI.FindNPC('SS39'), "SoldierNoWeapon");
       AI.ChangeLogic(AI.FindNPC('SS40'), "SoldierNoWeapon");
       
       AI.DisableDecamouflageMethod( AI.METHOD_BACKPACK, -1.0 );
       AI.DisableDecamouflageMethod( AI.METHOD_MOVE_WITH_OPPOSITE_WEAPON, -1.0 );
       AI.DisableDecamouflageMethod( AI.METHOD_STUPID_ACTIONS, -1.0 );
       AI.DisableDecamouflageMethod( AI.METHOD_USE_MEDKIT, -1.0 );       
       
       AI.AddBlockVisionBox( -276.403, -134.721, -3397.341, -251.403, -109.721, -3352.341, 'VB 0', 0.6, 0.25);
       AI.AddBlockVisionBox( -295.189, -134.721, -3346.960, -270.189, -109.721, -3301.960, 'VB 1', 0.6, 0.25);
       AI.AddBlockVisionBox( -418.750, -132.233, -3214.679, -393.750, -112.233, -3189.679, 'VB 2', 0.6, 0.25);
       AI.AddBlockVisionBox( -469.849, -132.233, -3182.349, -449.849, -112.233, -3162.349, 'VB 3', 0.5, 0.25);
       AI.AddBlockVisionBox( -514.097, -131.370, -3133.137, -494.097, -106.370, -3113.137, 'VB 4', 0.5, 0.25);
       
       local easyDisableTriggers    = { "VedroTrigger",     "SarajTrigger",     "BrevnaTrigger",     "ShowCaptainDocsMarkTrigger" };
       local nonEasyDisableTriggers = { "VedroTriggerEasy", "SarajTriggerEasy", "BrevnaTriggerEasy", "ShowCaptainDocsMarkTriggerEasy" };
       
       if (Level.GetDifficulty() == 0) then
          for i in easyDisableTriggers do
             local t = Level.FindTrigger( easyDisableTriggers[i] );
             if ( t != nil ) then
                Level.UnregisterTrigger( t );
             end;
          end
       else
          for i in nonEasyDisableTriggers do
             local t = Level.FindTrigger( nonEasyDisableTriggers[i] );
             if ( t != nil ) then            
                 Level.UnregisterTrigger( t );
             end;
          end
       end
       
       if (Level.GetDifficulty() == 3) then
          local t = Level.FindTrigger( "SimpleTrigger47" );
          if (t != nil) then
             Level.UnregisterTrigger( t );
          end
       end
       
       if (Level.GetDifficulty() == 3) then
          local form_eq = { 'WD01', 'WD02', 'WO02', 'WS01', 'WS02', 'WS03' };
          for i in form_eq do
             Level.HideItem( form_eq[i] );
          end
       end

       Actor.EnableUseCloth( Level.FindActor('SO06'), false );
     
       -- Timers..
       
       Level.InstallDpc("Level.PlayerNearHouseDisabled = true", 15.0 * 60.0);
       -- Level.InstallDpc("Level.EnableLevelMark('FORM', false)", 20.0);
                    
       -- Finish load..
       Level.OnFinishLoad();
  end;

  AI.DoFile( "scripts:Levels\\Common.lua", false );
  
------------------------------- Level logic ----------------------------------

--------------------------------------------------------
-- Name: Level.ChangeSoldierLogic()
-- Desc:
--------------------------------------------------------
   function Level.ChangeSoldierLogic(npc)
      AI.ChangeLogic(npc, "SovietSoldier");
   end

--------------------------------------------------------
-- Name: Level.InstallInitialTasks()
-- Desc:
--------------------------------------------------------
  function Level.InstallInitialTasks()
     Level.StartTask(MissionText.Task_Meet,       'MEET', "Levels\\Otstupniki\\meet_task.txt", true, 0 );  
     Level.StartTask(MissionText.Task_Diversion,  'DIVE', "Levels\\Otstupniki\\diversion_task.txt", true, 0 );

     Level.StartTask(MissionText.Task_Nikolaev,   'NIKO', "Levels\\Otstupniki\\nikolaev_task.txt", true, 0 );
     Level.StartTask(MissionText.Task_Shestakov,  'SHES', "Levels\\Otstupniki\\shestakov_task.txt", true, 0 );
     Level.StartTask(MissionText.Task_Starikov,   'STAR', "Levels\\Otstupniki\\starikov_task.txt", true, 0 );
  end

--------------------------------------------------------
-- Name: Level.RunLogic()
-- Desc:
--------------------------------------------------------
  function Level.RunLogic(completed)
     if (Level.CheckMissionTaskCompleted('DIVE', completed) == true and
         Level.CheckMissionTaskCompleted('SHES', completed) == true and
         Level.CheckMissionTaskCompleted('STAR', completed) == true and
         Level.CheckMissionTaskCompleted('NIKO', completed) == true and
         Level.HasMissionTask('RADI') == false) then

        Level.StartTask(MissionText.Task_Radio, 'RADI', "Levels\\Otstupniki\\radio_task.txt", true, 0 );
        return true; 
     end

     return false;
  end

--------------------------------------------------------
-- Name: Level.IsMissionTaskOver()
-- Desc:
--------------------------------------------------------
  function Level.IsMissionTaskOver(taskId)
  
     return Level.IsMissionTaskCompleted(taskId);
     
  end

--------------------------------------------------------
-- Name: Level.StartTask()
-- Desc:
--------------------------------------------------------
  function Level.StartTask(text, taskId, taskDscr, isImportant, floor )
     if (Level.HasMissionTask(taskId) != false) then
        return; 
     end
     
     if (taskId == 'DIVE') then
        Level.EnableLevelMark('DYN1', false);
        Level.EnableLevelMark('DYN2', false);
        Level.EnableLevelMark('DYN3', false);
        Level.EnableLevelMark('DYN4', false);
     elseif (taskId == 'MEET') then
        Level.EnableLevelMark('STRT', true);
        Level.EnableLevelMark('HOUS', false);
     elseif (taskId == 'RADI') then
        Level.EnableLevelMark('RADI', true);
     end

     Level.AddMissionTask( text, taskId, taskDscr, floor, isImportant );
  end

--------------------------------------------------------
-- Name: Level.FinishTask()
-- Desc:
--------------------------------------------------------
  function Level.FinishTask(taskId, completed)
     if (Level.HasMissionTask(taskId) == false or
         Level.IsMissionTaskCompleted(taskId) != false) then
        return; 
     end
     
     if (taskId == 'DIVE') then
        Level.EnableLevelMark('DYN1', false);
        Level.EnableLevelMark('DYN2', false);
        Level.EnableLevelMark('DYN3', false);
        Level.EnableLevelMark('DYN4', false);
     elseif (taskId == 'MEET') then
        Level.EnableLevelMark('STRT', false);
        Level.EnableLevelMark('HOUS', false);
     elseif (taskId == 'SHES') then
        Level.EnableLevelMark('SHES', false);
        Level.EnableLevelMark('SARA', false);
     elseif (taskId == 'NIKO') then
        Level.EnableLevelMark('NIKO', false);
        Level.EnableLevelMark('BREV', false);
     elseif (taskId == 'STAR') then
        Level.EnableLevelMark('STAR', false);
     elseif (taskId == 'RADI') then
        Level.EnableLevelMark('RADI', false);
     end
     
     if (completed != false) then     
        if (Level.RunLogic(taskId) == true) then
           Level.CompleteMissionTask(taskId);
           Level.AddLargeMessage( MissionText.Message_TaskChanged, 10.0, 255, 255, 255 );
        else
           Level.CompleteMissionTask(taskId);
        end        

        Level.PlayMenuSound("task_finish");
     else
        Level.RemoveMissionTask(taskId);
        
        if (Level.RunLogic(nil) == true) then
           Level.AddLargeMessage( MissionText.Message_TaskChanged, 10.0, 255, 255, 255 );
           Level.PlayMenuSound("task_finish");
        end
     end
  end
  
--------------------------------------------------------
-- Name: Level.CanChangeSynchroState()
-- Desc:
--------------------------------------------------------
  function Level.CanChangeSynchroState( SynchroAnchorsArray, npcIdArray )
    for i in npcIdArray do
       local npcId = npcIdArray[i];
       local npc = AI.FindNPC(npcId);
      
       if (npc != nil) then
      
          if (AI.GetAttention(npc) != AI.ATTENTION_RELAX) then
             return false;
          end
      
          local anchorId = SynchroAnchorsArray[npcId];
          if (anchorId == nil) then
             return false;
          end 
         
          local anchor = AI.FindAnchor(anchorId);
         
          if (anchor == nil) then
             return false;
          end
         
          if (AI.IsUsingAnchor(npc, anchor) == false) then
             return false;
          end
       end
    end  
  end
  
--------------------------------------------------------
-- Name: Level.CanChangeGlobalState()
-- Desc:
--------------------------------------------------------
function Level.CanChangeGlobalState()
   if (Level.CanChangeSynchroState( Level.SynchroAnchor, Level.GlobalScenaryNpc ) == false) then
      return false;
   end
   
   if (Level.GlobalState == 2) then
      return Level.SpyDialogCompleted == true;
   end
   
   return true;
end

--------------------------------------------------------
-- Name: Level.CanChangeSpyState()
-- Desc:
--------------------------------------------------------
function Level.CanChangeSpyState()
   if (Level.CanChangeSynchroState( Level.SpySynchroAnchor, Level.SpyNpc ) == false) then
      return false;
   end
   
   return true;
end

--------------------------------------------------------
-- Name: Level.ChangeSynchroState()
-- Desc:
--------------------------------------------------------
  function Level.ChangeSynchroState( state, npcArray, anchorsArray )
     for i in anchorsArray do
       anchorsArray[i] = nil;
     end
     
     local job = "state_" .. tostring(state);  
     
     for i in npcArray do
        AI.SetJob(AI.FindNPC(npcArray[i]), job);
     end
  end

--------------------------------------------------------
-- Name: Level.SafeRunAnchorJob2()
-- Desc:
--------------------------------------------------------
  function Level.SafeRunAnchorJob2()
     if (Level.PlayerNearHouse == true) then
        Level.RunAnchorJob_Run(AI.FindNPC('SPY1'), 'AN38', true);
        Level.RemoveDpc( "Level.RunAnchorJob_Run(AI.FindNPC('SPY1'), 'AN38', true)" );
     end
  end
  
--------------------------------------------------------
-- Name: Level.ChangeGlobalState()
-- Desc:
--------------------------------------------------------
  function Level.ChangeGlobalState( state )
     Level.GlobalState = state;
     
     Level.ChangeSynchroState( state, Level.GlobalScenaryNpc, Level.SynchroAnchor );
     
     if (state == 1) then
        Level.InstallDpc("Level.RunSoldierGroupScript()", 40.0);
        
        Level.EnableLevelMark('STRT', false);
        Level.EnableLevelMark('HOUS', true);
     end
     
     if (state == 3) then
        AI.SetJob(AI.FindNPC('SPY1'), "spy_state_4");
        AI.SetJob(AI.FindNPC('SPY2'), "spy_state_4");
        
        AI.RemoveScriptDynamicObstacle( 'FCDR' );
        
        Level.InstallDpc( "Level.RunAnchorJob(AI.FindNPC('SPY2'), 'AN37', true)", 50.0 );
        Level.InstallDpc( "Level.RunAnchorJob_Run(AI.FindNPC('SPY1'), 'AN38', true)", 110.0);
        
        Level.InstallDpc( "Level.SafeRunAnchorJob2()", 80.0 );
        
        Level.InstallDpc( "Level.InitFromCarJob()", 115.0);
        
        for i in Level.GlobalScenaryNpc do
           AI.ClearMemory( AI.FindNPC(Level.GlobalScenaryNpc[i]) );
        end
        
        for i in Level.SpyNpc do
           local npc = AI.FindNPC(Level.SpyNpc[i]);
           AI.DecamouflagePlayer( npc, false );
           Actor.MarkAsTarget( Level.FindActor(Level.SpyNpc[i]), true );
           
           AI.Disable(npc, "threat_as_know_player");
        end
        
        if (Level.PlayerNearHouse == true or Level.WasPlayerNearHouse == true) then
            Level.FinishTask('MEET');
        else
            Level.FinishTask('MEET', false);
        end
     end
     
     if (Level.GlobalState == 4) then
        -- Level.InstallDpc("Level.GroupGoToVillageAsPatrol()", 5.0);
        
        for i in Level.GlobalScenaryNpc do
           AI.ChangeLogic(AI.FindNPC(Level.GlobalScenaryNpc[i]), "DiversantSafe");
        end
        
        for i in Level.GlobalScenaryNpc do
           local actor = Level.FindActor(Level.GlobalScenaryNpc[i]);
           if (actor != nil) then
              Actor.MarkAsTarget( actor, true );
           end
        end
     end

     if (Level.GlobalState == 5) then
        Level.InstallDpc("Level.GroupGoToVillageAsPatrol()", 5.0);
     end
     
     if (Level.GlobalState == 6) then
        for i in Level.GlobalScenaryNpc do
           AI.ChangeLogic(AI.FindNPC(Level.GlobalScenaryNpc[i]), "Diversant");
        end
     
        Level.OrderScript();
        
        AI.OnPlayerLeaveZone("BeforeVillage_Global", 'BFGL');
        
        if (Level.IsMissionTaskCompleted('NIKO') == false) then
           Level.EnableLevelMark('NIKO', true);
        end
        
        if (Level.IsMissionTaskCompleted('SHES') == false) then
           Level.EnableLevelMark('SHES', true);
        end
        
        if (Level.IsMissionTaskCompleted('STAR') == false) then
           Level.EnableLevelMark('STAR', true);
        end
        
        if (Level.GetDifficulty() != 0) then
           Level.AddTimer( 'CSVT', "OnCheckSpyGroupVision", 4.0, true );
        end
        
        for i in Level.GlobalScenaryNpc do
           local npc = AI.FindNPC(Level.GlobalScenaryNpc[i]);
          
           AI.Enable(npc, "stone_reaction");
        end
        
        -- AI.Disable("npc_fire");
     end
  end

  --------------------------------------------------------
  -- Name: Level.InitFromCarJob()
  -- Desc:
  --------------------------------------------------------
  function Level.InitFromCarJob()
     local npc = AI.FindNPC('WS09');
     AI.SetJob(npc, "east_wait");
     Level.RunAnchorJob_Run(npc, 'AN56', true);
  end

  --------------------------------------------------------
  -- Name: Level.ChangeSpyState()
  -- Desc:
  --------------------------------------------------------
  function Level.ChangeSpyState( state )
     Level.SpyState = state;
     
     Level.ChangeSynchroState( state, Level.SpyNpc, Level.SpySynchroAnchor );
     
     if (Level.SpyState == 1) then
        AI.ChangeLogic(AI.FindNPC('SPY1'), "Diversant");
		AI.ChangeLogic(AI.FindNPC('SPY2'), "Diversant");
     end
     
     if (Level.SpyState == 3) then
        AI.HandleVoice(AI.FindNPC('SPY1'), "male_rus_script_script_52");
        
        Level.RunAnchorJob3_Run( AI.FindNPC('SPY2'), 'AN51', 'AN52', 'A274', true );
        Level.RunAnchorJob3_Run( AI.FindNPC('SPY1'), 'AN54', 'AN55', 'A275', true );
        
        for i in Level.SpyNpc do
           Actor.MarkAsTarget( Level.FindActor(Level.SpyNpc[i]), false );
        end
        
        Level.DisableVehicles( false );
        AI.SetJob(AI.FindNPC('SS03'), "sleep");
     end
  end
  
  --------------------------------------------------------
  -- Name: Level.OnNotifySynchroAnchor()
  -- Desc:
  --------------------------------------------------------
  function Level.OnNotifySynchroAnchor( npc, anchor )
     -- check can change state:
     
     local uid = AI.GetUID(npc);
     if (Level.GetIndex(Level.GlobalScenaryNpc, uid) != -1) then
     
        if (Level.CanChangeGlobalState() == true) then
           Level.ChangeGlobalState( Level.GlobalState + 1);
        end
     else
        if (Level.CanChangeSpyState() == true) then
           Level.ChangeSpyState( Level.SpyState + 1);
        end
     end
  end

--------------------------------------------------------
-- Name: Level.OnDynamiteFused()
-- Desc:
--------------------------------------------------------
  function Level.OnDynamiteFused( dynamiteId )
              
      if ( dynamiteId == 'DYN2' ) then
         Level.EnableSound( "tik_2" , true );         
      elseif ( dynamiteId == 'DYN1' ) then
         Level.EnableSound( "tik_1" , true );      
      elseif ( dynamiteId == 'DYN3' ) then
         Level.EnableSound( "tik_3" , true );      
      elseif ( dynamiteId == 'DYN4' ) then
         Level.EnableSound( "tik_4" , true );
      end;
      
  end

--------------------------------------------------------
-- Name: Level.OnEnterTriggerArea()
-- Desc:
--------------------------------------------------------
  function Level.OnEnterTriggerArea( sender, trgname, trgcmd )
     AI.Debug(nil, "Level.OnEnterTriggerArea", trgname);
     
     if (trgname == "PatrolCheckTrigger_01" or 
         trgname == "PatrolCheckTrigger_02" or
         trgname == "PatrolCheckTrigger_03") then
        Level.AddTimer( 'PTTM', "OnCheckPatrolDocs", 1.0, true );
     
     elseif (trgname == "CheckAlkogolicsTrigger") then
        Level.InstallSingleSmartDpc("Level.BeginAlkogolicsScript()", 1.0, "Level.CanBeginAlkogolicsScript()");
        
     elseif (trgname == "ShowCaptainDocsTrigger") then
     
        Level.InstallSingleSmartDpc("Level.ShowCaptainDocs()", 1.0, "Level.CanShowCaptainDocs()");
     
     end
  end
    
--------------------------------------------------------
-- Name: Level.OnLeaveTriggerArea()
-- Desc:
--------------------------------------------------------
  function Level.OnLeaveTriggerArea( sender, trgname, trgcmd )
     AI.Debug(nil, "Level.OnLeaveTriggerArea", trgname);
    
     if (trgname == "PatrolCheckTrigger_01" or 
         trgname == "PatrolCheckTrigger_02" or
         trgname == "PatrolCheckTrigger_03") then
        Level.RemoveTimer( 'PTTM' );
     end
     
     if (trgname == "CheckAlkogolicsTrigger") then
        Level.RemoveDpc("Level.BeginAlkogolicsScript()");

        AI.FailTask(AI.FindNPC('SS79'), AI.TASK_SCRIPT_DEFAULT);
        AI.FailTask(AI.FindNPC('SS78'), AI.TASK_SCRIPT_DEFAULT);
        
     elseif (trgname == "ShowCaptainDocsTrigger") then
        Level.RemoveDpc("Level.ShowCaptainDocs()");
        -- Level.RemovePlayerAction('CPAS');
        Level.SafeRemoveLevelPlayerAction('CPAS');
     end
  end

--------------------------------------------------------
-- Name: Level.OnExecutePlayerAction()
-- Desc:
--------------------------------------------------------
  function Level.OnExecutePlayerAction(id, completeUnregisterTrigger ) 
  
     if (Level.CanAddPlayerAction(id) == nil) then
        return false;
     end
     
     local onFinishUnregister = false;
       
     if (id == "TestTrigger") then
        if ( Level.StartPlayerCustomAnim("Custom_ShelfOverturn", 0, true, true, 'TEST') == false ) then
           return false;
        end;
        
     elseif (id == "DynamiteTrigger_01" or 
             id == "DynamiteTrigger_02" or
             id == "DynamiteTrigger_03" or
             id == "DynamiteTrigger_04") then
     
        local dyn = {};
        
        dyn["DynamiteTrigger_01"] = 'DYN1';
        dyn["DynamiteTrigger_02"] = 'DYN2';
        dyn["DynamiteTrigger_03"] = 'DYN3';
        dyn["DynamiteTrigger_04"] = 'DYN4';

        if ( Level.StartPlayerCustomAnim("Setup_Mine2_Crouch", 0, true, true, dyn[id]) == false ) then
           return false;
        end;
        
        local pos={};
        pos.x,pos.y,pos.z = Trigger.GetPosition( Level.FindTrigger( id ) );
        
        local playerNode = Actor.GetNode( Level.GetPlayer() );
        local playerDir  = {};
        
        playerDir.x,playerDir.y,playerDir.z = node.GetDirection( playerNode );
        
        Actor.BlendTransform( Level.GetPlayer(), pos.x + playerDir.x * 4.0, pos.y, pos.z + playerDir.z * 4.0, 3.0);
        
        AI.StartDecamouflage( 50.0, 100.0, 2.5 );
        
     elseif (id == "CutBrevnaTrigger") then
     
        if ( Level.StartPlayerCustomAnim("Custom_RopeCut", 0, true, true, 'CTBR') == false ) then
           return false;
        end;
        
        AI.StartDecamouflage( 100.0, 200.0, 4.5 );
        
        Level.InstallDpc("Level.DoBrevnaCutscene()", 1.0);
        
     elseif (id == "CutBoatRopeTrigger") then

        if ( Level.StartPlayerCustomAnim("Custom_RopeCut", 0, true, true, 'CTBT') == false ) then
           return false;
        end;
        
        AI.StartDecamouflage( 50.0, 100.0, 2.5 );
        
     elseif (id == "DropBucketTrigger") then
     
        if ( Level.StartPlayerCustomAnim("Custom_Pail", 0, true, true, 'DBTG') == false ) then
           return false;
        end;
        
     elseif (id == "CloseDoorTrigger") then
        
        if ( Level.StartPlayerCustomAnim("Custom_BoltClose", 0, true, true, 'CLDR', false ) == false ) then
           return false;
        end;
        
     elseif (id == "UseRadioTrigger") then
     
        if ( Level.StartPlayerCustomAnim("Custom_Radio", 0, true, true, 'CSRD') == false ) then
           return false;
        end;

     end
             
     if ( onFinishUnregister == false ) then
     
        Level.FinishAnimTrigger    = id;
        Level.FinishAnimUnregister = completeUnregisterTrigger;
     
     else
     
        Level.FinishAnimTrigger    = "";
        
        if ( completeUnregisterTrigger == true ) then
        
            local t = Level.FindTrigger( id );
            if ( t != nil ) then            
                Level.UnregisterTrigger( t );
            end;
        end;
     end;
     
     return true;
     
  end

--------------------------------------------------------
-- Name: Level.CanAddPlayerAction()
-- Desc:
--------------------------------------------------------
  function Level.CanAddPlayerAction(id)

     -- playing custom animation..
     
     if ( Level.FinishAnimTrigger != "" ) then
        return nil;     
     end;
     
     if (id == "CutBrevnaTrigger") then
        if (Level.PlayerHasKnife() == true and Level.BrevnaRopeCutted == false) then
           return MissionText.Action_CutRopeBrevna;
        end
        
     elseif (id == "DynamiteTrigger_01" or 
             id == "DynamiteTrigger_02" or
             id == "DynamiteTrigger_03" or
             id == "DynamiteTrigger_04") then
     
        local dyn = {};
        dyn["DynamiteTrigger_01"] = 'DYN1';
        dyn["DynamiteTrigger_02"] = 'DYN2';
        dyn["DynamiteTrigger_03"] = 'DYN3';
        dyn["DynamiteTrigger_04"] = 'DYN4';
        
        if (Level.DynamiteFusedState[dyn[id]] == "fused") then
           return MissionText.Action_Demine;
        end
       
     elseif (id == "CutBoatRopeTrigger")  then

        if (Level.PlayerHasKnife() == true and Level.BoatRopeCutted == false) then
           return MissionText.Action_CutRopeBoat;
        end
        
     elseif (id == "DropBucketTrigger") then

        return MissionText.Action_DropBucket;
        
     elseif (id == "CloseDoorTrigger") then
      
        local d = Level.FindDoor('SNDR');
        if (d == nil) then
           print("Error: Can't find sauna door: 'SNDR'");   
           return nil;
        end
        
        if (Level.SpyAtSauna == true and Level.IsDoorClosed(d) == true) then        
           return MissionText.Action_CloseDoor;
        end
        
     elseif (id == "UseRadioTrigger") then
     
        if (Level.IsMissionTaskCompleted('NIKO') == true and
            Level.IsMissionTaskCompleted('SHES') == true and
            Level.IsMissionTaskCompleted('STAR') == true and
            (Level.IsMissionTaskCompleted('MEET') == true or Level.HasMissionTask('MEET') == false) and
            Level.IsMissionTaskCompleted('DIVE') == true) then
            
            return MissionText.Action_UseRadio;
            
        end        
     end
       
     return nil;
  end

  --------------------------------------------------------
  -- Name: Level.OnAlert()
  -- Desc:
  --------------------------------------------------------
  function Level.OnAlert( alertGroupId )
     AI.Debug(npc, "Level.OnAlert", tostring(alertGroupId));
     
     if (alertGroupId != 10) then
        Level.OnFailedMission( MissionText.Failed_Alert );
     else
        Level.OnFailedMission( MissionText.Failed_AlertDiver );
     end
  end

  --------------------------------------------------------
  -- Name: Level.OnFinishAlert()
  -- Desc:
  --------------------------------------------------------
  function Level.OnFinishAlert( alertGroupId )
     AI.Debug(nil, "Level.OnFinishAlert", tostring(alertGroupId));
     
     -- TODO...     
  end

  --------------------------------------------------------
  -- Name: Level.OnStopMove()
  -- Desc:
  --------------------------------------------------------
  function Level.OnStopMove( actorId , npc )

     if (npc == nil) then
        print("Bad npc " .. tostring(actorId));
        return;
     end

     local npcForm    = AI.GetForm( npc );
     local zone       = AI.GetPrimaryPlayerZone( npc );
     local playerForm = AI.GetPlayerForm();
     
     if (zone == nil) then 
        return;
     end
          
     if (zone == "WeaponHouseNear") then
        Level.AddSmallMessage( MissionText.Message_StopMove_WeaponHouseNear, 5.0, 175, 175, 175 );
        
        if (Level.IsPlayerOfficer() == true) then
           if (playerForm != "Major") then
              AI.HandleVoice( npc, "male_rus_stopmove_stopmove_02" );
           else
              AI.HandleVoice( npc, "male_rus_stopmove_stopmove_04" );
           end
        else
           AI.HandleVoice( npc, "@v_stop_move" );
        end
                
     elseif (zone == "WeaponHouse") then
        Level.AddSmallMessage( MissionText.Message_StopMove_WeaponHouseNear, 5.0, 175, 175, 175 );
        
        if (Level.IsPlayerOfficer()) then
           if (playerForm != "Major") then
              AI.HandleVoice( npc, "male_rus_stopmove_stopmove_02" );
           else
              AI.HandleVoice( npc, "male_rus_stopmove_stopmove_04" );
           end
        else
           AI.HandleVoice( npc, "@v_stop_move" );
        end
        
     elseif (zone == "MainHouseNear") then
        Level.AddSmallMessage( MissionText.Message_StopMove_MainHouseNear, 5.0, 175, 175, 175 );
        AI.HandleVoice( npc, "male_rus_stopmove_stopmove_06" );
        
     elseif (zone == "MainHouse") then
        Level.AddSmallMessage( MissionText.Message_StopMove_MainHouse, 5.0, 175, 175, 175 );
        
        if (playerForm == "Soldier") then
           AI.HandleVoice( npc, "male_rus_stopmove_stopmove_05" );
        else
           AI.HandleVoice( npc, "male_rus_stopmove_stopmove_07" );
        end
     
     elseif (zone == "Constr") then
        
        if (Level.IsPlayerOfficer() == true) then
           if (playerForm != "Major") then
              Level.AddSmallMessage( MissionText.Message_StopMove_Const_Officer, 5.0, 175, 175, 175 );
              AI.HandleVoice( npc, "male_rus_stopmove_stopmove" );
           else
              Level.AddSmallMessage( MissionText.Message_StopMove_Const_Major, 5.0, 175, 175, 175 );
              AI.HandleVoice( npc, "male_rus_stopmove_stopmove_03" );
           end
        else
           Level.AddSmallMessage( MissionText.Message_StopMove_Const, 5.0, 175, 175, 175 );
           AI.HandleVoice( npc, "male_rus_stopmove_stopmove_06" );
        end
        
     end

     -- AI.HandleVoice( npc, AI.VOICE_STOP_MOVE );
  end

  --------------------------------------------------------
  -- Name: Level.OnReadDocs()
  -- Desc:
  --------------------------------------------------------
  function Level.OnReadDocs()
     local npc = Level.GetReadMan();
     if (npc != nil) then
        local properties = Level.CreateCustomParams();

        Level.SetValue(properties, "CustomString_1", "Act_Stand_ArmyHi:^male_rus_script_script_68" );
        Level.SetValue(properties, "CustomString_2", "5.0" );
        Level.SetValue(properties, "CustomString_3", "" );

        AI.RunScriptTask(npc, "scripts:job\\PlayerAnimTask.lua", AI.LOGIC_DEFAULT, properties);

        Level.VoiceMessage(npc, nil, "Message_DocsClear");
        
        Level.PatrolPassShowed = true;
        Level.InstallSingleDpc("Level.PatrolPassShowed = false", 600.0);
     end
  end
  --------------------------------------------------------
  -- Name: Level:OnPlayerAction()
  -- Desc:
  --------------------------------------------------------
  function Level:OnPlayerAction(id)
     if (id == 'PASS') then
        if (Level.PassState == "PatrolCheck") then
           local patrolCheckNpc = Level.GetPatrolCheckMan();
           
           Level.StartPlayerCustomAnim("Custom_PassticketShow", 0, true, true);
           
           if (patrolCheckNpc != nil) then
               local properties = Level.CreateCustomParams();

               Level.SetValue(properties, "CustomString_1", "Level.OnReadDocs()" );
               Level.SetValue(properties, "CustomString_2", "6.0" );

               AI.RunScriptTask(patrolCheckNpc, "scripts:job\\ReadDocsTask.lua", AI.LOGIC_DEFAULT, properties);
           end

           --Level.RemovePlayerAction(id);
           Level.SafeRemoveLevelPlayerAction(id);
           Level.RemoveTimer('PSTM');
        end
     elseif (id == 'CPAS') then
        
        if (Level.CanShowCaptainDocs() == true) then
           Level.StartPlayerCustomAnim("Custom_PassticketShow", 0, true, true);
           Level.InstallDpc("Level.OnShowCaptainDocs()", 2.0);
           Level.CaptainDocsScriptCompleted = true;
           AI.EnableZone("DigZone", false);
           Level.EnableLevelMark('SCDT', false);
        end
        
        --Level.RemovePlayerAction(id);
        Level.SafeRemoveLevelPlayerAction(id);
     end
  end

  --------------------------------------------------------
  -- Name: Level.PlayCustomAnimSound()
  -- Desc:
  --------------------------------------------------------
  function Level.PlayCustomAnimSound( soundName )
      
     local n = table.getn( Level.PlayerAnimSounds );
     local s = Level.PlayCustomSound( soundName );
     if ( s == nil ) then
       return;
     end;
     
     Level.PlayerAnimSounds[ n + 1 ] = s;
     
  end;
  
  --------------------------------------------------------
  -- Name: Level.StopAllCustomAnimSounds()
  -- Desc:
  --------------------------------------------------------
  function Level.StopAllCustomAnimSounds()
  
     for i in Level.PlayerAnimSounds do
       Level.StopCustomSound( Level.PlayerAnimSounds[i] );          
     end
     
     Level.PlayerAnimSounds = {};
     
  end;
  
  --------------------------------------------------------
  -- Name: Level.OnStartPlayerCustomAnim()
  -- Desc:
  --------------------------------------------------------
  function Level.OnStartPlayerCustomAnim( animId )
    
       if ( animId == 'CLDR' ) then
          Level.EnableWorldObjectAnim( Level.FindWorldObject('SNDR'), true, 0.0, 25.0, 30.0, 0.0, false );
       elseif ( animId == 'DYN1' ) then
          Level.PlayCustomAnimSound( 'mine_1');       
       elseif ( animId == 'DYN2' ) then
          Level.PlayCustomAnimSound( 'mine_2');       
       elseif ( animId == 'DYN3' ) then
          Level.PlayCustomAnimSound( 'mine_3');       
       elseif ( animId == 'DYN4' ) then
          Level.PlayCustomAnimSound( 'mine_4');       
       end;
              
  end;
    
  --------------------------------------------------------
  -- Name: Level.OnFinishPlayerCustomAnim()
  -- Desc:
  --------------------------------------------------------
  function Level.OnFinishPlayerCustomAnim(animName, animUniqueId, boolBreaked )
 
     if ( boolBreaked == true ) then
        Level.OnBreakActionTrigger();
        AI.StopDecamouflage();
        Level.StopAllCustomAnimSounds();

        return;
     end;

     if (animUniqueId == 'CTBR') then
        Level.DoBrevnaScript();
     elseif (animUniqueId == 'CTBT') then
        Level.DoBoatScript();
     elseif (animUniqueId == 'DBTG') then
        Level.DoVedroScript();
     elseif (animUniqueId == 'CLDR') then
        Level.CloseSaunaDoor( true );
     elseif (animUniqueId == 'CSRD') then
        Level.InstallDpc("Level.FinishTask('RADI')", 3.0);
     elseif (animUniqueId == 'DYN1' or
             animUniqueId == 'DYN2' or
             animUniqueId == 'DYN3' or
             animUniqueId == 'DYN4') then

        Level.UnMineDynamite(animUniqueId);

     end
     
     if ( Level.FinishAnimTrigger != "" and Level.FinishAnimUnregister == true ) then
     
         local t = Level.FindTrigger( Level.FinishAnimTrigger );
         if ( t != nil ) then
            Level.UnregisterTrigger( t );         
         end;
            
     end;
     
     Level.FinishAnimTrigger    = "";
     Level.FinishAnimUnregister = false;
     
     Level.PlayerAnimSounds     = {};
       
  end
 

  --------------------------------------------------------
  -- Name: Level.OnFinishCutScene()
  -- Desc:
  --------------------------------------------------------
  function Level.OnFinishCutScene( cutscene, boolBreaked, cutsceneName )
      CutScene.Activate(nil);
  end;
  
  --------------------------------------------------------
  -- Name: Level.OnInventoryChanged()
  -- Desc:
  --------------------------------------------------------
  function Level.OnInventoryChanged()
     local player = Level.GetPlayer();
     if (Actor.HasCustomEquipment(player, 'PLAN') == true) then
        for i in Level.DynamiteFusedState do
           if (Level.DynamiteFusedState[i] != "completed") then
              Level.EnableLevelMark(i, true);
           end
        end
     end
     
     -- TODO. Check form at backpack...
     --	Level.EnableLevelMark('FORM', false);
  end
  
--------------------- Music and other funny stuff ----------------------------

----------------------- Bot idles and ai scripts -----------------------------

---------------------------------- Callbacks ---------------------------------

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor04()
-- Desc:
--------------------------------------------------------
  function Level.OnAnchor_AIAnchor04()
     Level.RunAnchorJob_Run( AI.FindNPC('STAR'), 'AN10', true );
     Level.RunAnchorJob_Run( AI.FindNPC('SHES'), 'AN11', true );
  end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor19()
-- Desc:
--------------------------------------------------------
  function Level.OnAnchor_AIAnchor19()
     if (AI.IsDefault(AI.FindNPC('SPY2')) == true and
         AI.IsDefault(AI.FindNPC('SPY1')) == true) then
        
        Level.RunAnchorJob(AI.FindNPC('SPY2'), 'AN26', false);
        Level.RunAnchorJob(AI.FindNPC('SPY1'), 'AN23', false);
     end
  end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor27()
-- Desc:
--------------------------------------------------------
  function Level.OnAnchor_AIAnchor27()
     if (Level.SpyDialogCompleted == false) then
        if (Level.CheckBeginSpyDialogConditions() == true) then
        
           if (Level.PlayerNearHouse == true) then
              Level.WasPlayerNearHouse = true;
           end
           
           Level.BeginSpyDialog();
        else
           Level.InstallSmartDpc("Level.BeginSpyDialog()", 1.0, "Level.CheckBeginSpyDialogConditions()");
        end
     end
  end
  
--------------------------------------------------------
-- Name: Level.CheckBeginSpyDialogConditions()
-- Desc: 
--------------------------------------------------------
  function Level.CheckBeginSpyDialogConditions()
     local starikov = AI.FindNPC('STAR');
     local spy = AI.FindNPC('SPY2');
     
     assert(starikov != nil and spy != nil, "Scenario failed. Starikov or spy dead");
     assert(Level.SpyDialogCompleted == false, "Spy dialog has been already completed");
     
     if ( Level.IsUsingAnchor(starikov, 'AN27') == true and
         (Level.PlayerNearHouse == true or Level.PlayerNearHouseDisabled == true) and
         (Level.IsUsingAnchor(spy, 'AN26') or AI.IsDefault(spy)) ) then
         
         return true;                           
     end
     
     return false;
  end

--------------------------------------------------------
-- Name: Level.BeginSpyDialog()
-- Desc:
--------------------------------------------------------
  function Level.BeginSpyDialog()
     
     local messages = { "", 
                        MissionText.Message_CutScene_SpyInvite, 
                        MissionText.Message_CutScene_SpyInvite, 
                        "", 
                        MissionText.Message_CutScene_SpyRespond};
     
     if (Level.PlayerNearHouse == true) then
        Level.BeginCutScene("SpyCutscene", "Levels\\Otstupniki\\spycutscene.scm", messages, 16.0, { 3, 0.0, 60.0, 100.0, 255 } );
     end
     
     AI.SetJob(AI.FindNPC('SPY2'), "wait_synchro");
     Level.RunAnchorJob2( AI.FindNPC('SPY2'), 'AN22', 'AN21', true );
     
     -- TODO. disable on see fail...
  end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor21()
-- Desc:
--------------------------------------------------------
  function Level.OnAnchor_AIAnchor21()
     Level.RunAnchorJob2( AI.FindNPC('STAR'), 'AN25', 'AN28', true );
  end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor28()
-- Desc:
--------------------------------------------------------
  function Level.OnAnchor_AIAnchor28()
     Level.SpyDialogCompleted = true;
     
     Level.RemoveDpc("Level.BeginSpyDialog()");
  end
  
--------------------------------------------------------
-- Name: Level.OnSeeCustomObject()
-- Desc:
--------------------------------------------------------
function Level.OnSeeCustomObject(npc, netId)
   AI.Debug(npc, "Level.OnSeeCustomObject", tostring(netId));
end

--------------------------------------------------------
-- Name: Level.RunSoldierGroupScript()
-- Desc:
--------------------------------------------------------
function Level.RunSoldierGroupScript()
   local soldiers = { 'WS04', 'WS05', 'WS06', 'WS07', 'WS08', 'WS09', 'WS10' };
   for i in soldiers do
      AI.SetJob( AI.FindNPC(soldiers[i]), "east_job" );
   end
end

--------------------------------------------------------
-- Name: Level.OnAssignSynchroAnchor()
-- Desc:
--------------------------------------------------------
function Level.OnAssignSynchroAnchor( npcId, anchorId )
   if (Level.GetIndex(Level.GlobalScenaryNpc, npcId) != -1) then
      Level.SynchroAnchor[npcId] = anchorId;
   else
      Level.SpySynchroAnchor[npcId] = anchorId;
   end
end

--------------------------------------------------------
-- Name: Level.GetPatrolCheckMan()
-- Desc:
--------------------------------------------------------
function Level.GetPatrolCheckMan()
   local job = AI.GetScriptJob("TASK_SCRIPT_PATROL_CHECK");
   if (job != nil) then
     return Job.GetNPC( job );
   end

   return nil; 
end

--------------------------------------------------------
-- Name: Level.GetReadMan()
-- Desc:
--------------------------------------------------------
function Level.GetReadMan()
   local job = AI.GetScriptJob("TASK_SCRIPT_READ_DOCS");
   if (job != nil) then
     return Job.GetNPC( job );
   end

   return nil; 
end

--------------------------------------------------------
-- Name: Level.CanPatrolCheck()
-- Desc:
--------------------------------------------------------
function Level.CanPatrolCheck(npc)
   if (npc == nil) then
      return false;
   end
   
   local player = Level.GetPlayer();
   local entity = AI.GetActor(npc);
   
   if (Level.IsPlayerInVehicle() == true) then
      return false;
   end
   
   if (AI.GetPlayerForm() == "Civilian") then
      return false;
   end
   
   if (AI.IsDefault(npc) == false) then
      return false;
   end
   
   local distance = Level.BalanceDistance( Level.GetEntityPosition(player), 
                                           Level.GetEntityPosition(entity) );
                                           
   if (distance > 60.0) then
      return false;
   end
   
   if (AI.HasPlayerInfo( npc, "see" ) == false or
       AI.HasPlayerInfo( npc, "know" ) == true ) then
      return false;
   end
   
   return true;
end

--------------------------------------------------------
-- Name: Level.CanLevelPatrolCheck()
-- Desc:
--------------------------------------------------------
function Level.CanLevelPatrolCheck()
   if (Level.PatrolPassShowed == true) then
      return false;
   end
   
   return true;
end

--------------------------------------------------------
-- Name: Level.InitPatrolCheckScript()
-- Desc:
--------------------------------------------------------
function Level.InitPatrolCheckScript( npc )
   local properties = Level.CreateCustomParams();     

   Level.SetValue(properties, "CustomString_1", "PlayerFront" );

   AI.RunScriptTask(npc, "game:Levels\\Otstupniki\\Jobs\\PatrolCheckTask.lua", AI.LOGIC_DEFAULT, properties);
   
   -- activate dynamic cutscene
   local cameraName = "Levels\\Otstupniki\\dynamic.scm";
   local cs = Level.BeginCutScene("Dynamic", cameraName, MissionText.Message_CutScene_Docs, 3.0, { 1, 0, 300.0, 500.0, 255 } );
   
   -- npcPos = 1782.3077, -42.5229, 383.1298, 1788.2489, -23.4350, 393.1255
   -- 1768.620605 51.191025 347.158325
   
   assert(npc != nil, "");
   local playerPos = Level.GetEntityPosition(Level.GetPlayer());
   local npcPos    = Level.GetNpcPosition( npc );
   local pos = { };
   pos.x = (playerPos.x + npcPos.x) * 0.5 + (-16.657695);
   pos.y = (playerPos.y + npcPos.y) * 0.5 + 64.169975; --84.169975;
   pos.z = (playerPos.z + npcPos.z) * 0.5 + (-40.969325);

   pos.x = npcPos.x + (-16.657695);
   pos.y = npcPos.y + 64.169975;
   pos.z = npcPos.z + (-40.969325);
  
   CutScene.SetCameraParam(cs, cameraName, "pos" , pos.x, pos.y, pos.z );
   
   if ((Level.PlayerHasPass() == true) and 
       (Level.HasPlayerAction('PASS') == false)) then
        
       Level.PassState = "PatrolCheck";
       
--       Level.AddPlayerAction('PASS', MissionText.Message_ShowDocs, "Level", false );
       Level.SafeAddLevelPlayerAction('PASS', MissionText.Message_ShowDocs);
       
       Level.AddTimer('PSTM', "OnCheckShowPass", 1.0, true );
   end   
end

--------------------------------------------------------
-- Name: Level.OnCheckShowPass()
-- Desc:
--------------------------------------------------------
function Level.OnCheckShowPass()
   local npc = Level.GetPatrolCheckMan();

   if (npc == nil) then
      --Level.RemovePlayerAction('PASS');
      Level.SafeRemoveLevelPlayerAction('PASS');
      Level.RemoveTimer('PSTM');
   end
end


--------------------------------------------------------
-- Name: Level.OnCheckPatrolDocs()
-- Desc:
--------------------------------------------------------
function Level.OnCheckPatrolDocs()
   if (Level.GetPatrolCheckMan() != nil) then
      return;
   end
   
   if (Level.CanLevelPatrolCheck() == false) then
      return;
   end
   
   for i in Level.PatrolMan do
      local npc = AI.FindNPC(Level.PatrolMan[i]);
      if (Level.CanPatrolCheck(npc) == true) then
          -- TODO... Begin dynamic cutscene...

          Level.InitPatrolCheckScript(npc);
      end
   end
end

--------------------------------------------------------
-- Name: Level.PlayerHasPass()
-- Desc:
--------------------------------------------------------
function Level.PlayerHasPass()
   local player = Level.GetPlayer();
   return (Actor.HasCustomEquipment(player, 'PASS') == true);
end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor56()
-- Desc:
--------------------------------------------------------
function Level.OnAnchor_AIAnchor56()
   -- Level.InstallDpc("Level.GroupGoToVillageAsPatrol()", 25.0);
end

--------------------------------------------------------
-- Name: Level.GroupGoToVillageAsPatrol()
-- Desc:
--------------------------------------------------------
function Level.GroupGoToVillageAsPatrol()
   local offset = {};
   offset['WS06'] = { x = -10.0, z = -8.0 };
   offset['WS05'] = { x =  10.0, z = -8.0 };
   offset['WS07'] = { x = -10.0, z = -16.0 };
   offset['WS04'] = { x =  10.0, z = -16.0 };
   offset['WS10'] = { x = -10.0, z = -24.0 };
   offset['WS09'] = { x =  10.0, z = -24.0 };
   
   local commander = AI.FindNPC('WS08');
   AI.SetJob(commander, "go_to_village");
   AI.ChangeLogic( commander, "PatrolSafe" );
   
   AI.HandleVoice( commander, "male_rus_script_script_52" );
   
   for i in offset do
      local npc = AI.FindNPC( i );
      if (npc != nil) then
         local properties = {};
         
         properties["DistanceRun"]    = true;
         properties["ParentPolicy"]   = true;
         properties["WatchCommander"] = true;
         properties["TurnCommander"]  = false;
         properties["RaisedWeapon"]   = false;
       
         AI.ChangeLogic( npc, "PatrolSafe" );
         
         AI.FollowActor( npc, 
                         AI.GetActor(commander), 
                         offset[i].x, 
                         offset[i].z, 
                         Level.ToCustomParams(properties));
      end      
   end
end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor92()
-- Desc:
--------------------------------------------------------
function Level.OnAnchor_AIAnchor92()
   local doctor = AI.FindNPC('DCT1');
   if (doctor != nil) then
      Level.RunAnchorJob(doctor, 'AN93'); 
   end
end

--------------------------------------------------------
-- Name: Level.OnResumeOldPos()
-- Desc:
--------------------------------------------------------
function Level.OnResumeOldPos()
   local npc = AI.FindNPC(Level.ToDoctorNpc);
   if (npc != nil) then
      Level.RunAnchorJob(npc, 'AN96', false);

      local doctor = AI.FindNPC('DCT1');
      if (doctor != nil) then
         AI.HandleVoice(doctor, "male_rus_script_script_19");
      end      
   end
end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor93()
-- Desc:
--------------------------------------------------------
function Level.OnAnchor_AIAnchor93()
   local npc = AI.FindNPC(Level.ToDoctorNpc);
   if (npc != nil) then
      Level.RunAnchorJob(npc, 'AN95', false);
      Level.InstallSingleDpc("Level.OnResumeOldPos()", 7.0);
   end
end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor96()
-- Desc:
--------------------------------------------------------
function Level.OnAnchor_AIAnchor96()	
   Level.InstallDpc("Level.NextDoctorNpc()", 6.0);
end

--------------------------------------------------------
-- Name: Level.NextDoctorNpc()
-- Desc:
--------------------------------------------------------
function Level.NextDoctorNpc()
   local npcId = { 'SS28', 'SS54', 'SS52', 'SS56' };
   local index = Random( table.getn(npcId) );
   
   Level.ToDoctorNpc = npcId[ index + 1 ];
   
   if (Level.ToDoctorNpc != nil) then
      local npc = AI.FindNPC(Level.ToDoctorNpc);
      if (npc != nil) then
         local anchor = AI.FindAnchor('AN96');
         if (AI.IsAnchorBinded(anchor) == false) then
            AI.AnchorBindProtect(anchor, true);
            Level.RunAnchorJob2(npc, 'AN92', 'AN96', true);
         end
      end
   end
end

--------------------------------------------------------
-- Name: Level.OnTrigger_NearBoxes()
-- Desc:
--------------------------------------------------------
function Level.OnTrigger_NearBoxes()
   AI.SetJob( AI.FindNPC('SS58'), "working");
   AI.SetJob( AI.FindNPC('SS60'), "working");
   
   AI.HandleVoice( AI.FindNPC('SS58'), "%Script08_Sound" );
end

--------------------------------------------------------
-- Name: Level.OnDropLastBox()
-- Desc:
--------------------------------------------------------
function Level.OnDropLastBox(actorId)
   AI.SetJob( AI.FindNPC(actorId), "relax");
end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor129()
-- Desc:
--------------------------------------------------------
function Level.OnAnchor_AIAnchor129()
   local officer = AI.FindNPC('SO05');
   local soldier = AI.FindNPC('SS09');
   
   if (AI.IsDefault(soldier) == true) then
      Level.RunAnchorJob(soldier, 'A130', false);
   end
   
   NPC.SetHeadPolicy(soldier, NPC.HEAD_POLICY_DEFAULT);
   
   Level.RunAnchorJob3(officer, 'A137', 'A131', 'A138', false);
end

--------------------------------------------------------
-- Name: Level.OnTrigger_SimpleTrigger15()
-- Desc:
--------------------------------------------------------
function Level.OnTrigger_SimpleTrigger15()
   local officer = AI.FindNPC('SO05');
   local soldier = AI.FindNPC('SS09');

   AI.SetJob(officer, "move");
      
   if (AI.IsDefault(officer) == true and
       AI.IsDefault(soldier) == true) then
   
      Level.RunAnchorJob(officer, 'A129', true);
   end
end

--------------------------------------------------------
-- Name: Level.OnDinnerPrepare()
-- Desc:
--------------------------------------------------------
function Level.OnDinnerPrepare()
   local soldiers = { 'WS05', 'WS10', 'WS04', 'WS07', 'WS06', 'WS09' };
                
   for i in soldiers do
      local npc = AI.FindNPC(soldiers[i]);
      AI.SetJob(npc, "dinner_prepare");
   end
   
   AI.SetJob(AI.FindNPC('WS08'), "dinner");
end

--------------------------------------------------------
-- Name: Level.OnNextDinnerMan()
-- Desc:
--------------------------------------------------------
function Level.OnNextDinnerMan()
   local soldiers = { 'WS05', 'WS10', 'WS04', 'WS07', 'WS06', 'WS09' };

   Level.DinnerMan = Level.DinnerMan + 1;
   if (soldiers[Level.DinnerMan] == nil) then
      return;
   end
   
   local soldier = AI.FindNPC(soldiers[Level.DinnerMan]);
   
   if (soldier == nil) then
      Level.OnNextDinnerMan();
      return;
   end
   
   AI.SetJob(soldier, "dinner");
   Level.RunAnchorJob(soldier, 'A141', true);
end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor59()
-- Desc:
--------------------------------------------------------
function Level.OnAnchor_AIAnchor59()
   Level.OnDinnerPrepare();
   Level.InstallDpc("Level.OnNextDinnerMan()", 7.0);
end

--------------------------------------------------------
-- Name: Level.OnStartAnimationNotify()
-- Desc:
--------------------------------------------------------
function Level.OnStartAnimationNotify( npc, animName, cascadePhase)
   if (npc == AI.FindNPC('SO13') and
       animName == "Act_Rasplata_Drink2_Sit") then
       
       Level.RunAnchorJob2_Run(AI.FindNPC('SS80'), 'A178', 'A179', true);
   end
end

--------------------------------------------------------
-- Name: Level.DoFollow()
-- Desc:
--------------------------------------------------------
function Level.DoFollow(actorId, commanderId, off)
   local properties = {};
         
    properties["DistanceRun"]    = true;
    properties["ParentPolicy"]   = true;
    properties["WatchCommander"] = true;
    properties["TurnCommander"]  = true;
    properties["RaisedWeapon"]   = true;
      
    local npc = AI.FindNPC(actorId);
    if (npc == nil) then
       return;
    end
      
    local commander = AI.FindNPC(commanderId);
    if (commander == nil) then
       return;
    end
    
    local x = -10.0;
    local z = -15.0;
    
    if (off != nil) then
       x = off.x;
       z = off.z;
    end
    
    AI.FollowActor( npc, 
                    AI.GetActor(commander), 
                    x, 
                    z, 
                    Level.ToCustomParams(properties));
end

--------------------------------------------------------
-- Name: Level.HackChangeState()
-- Desc:
--------------------------------------------------------
function Level.HackChangeState()
     local actors  = { 'SHES', 'STAR', 'NIKO' };
     local pos     = { { x = 1231.8258, y = -42.4968, z = -1615.3380 },
                       { x = 1237.1627, y = -42.4968, z = -1625.1491 },
                       { x = 1233.3028, y = -42.4968, z = -1638.8365 } };

     for i in actors do
        local npc = AI.FindNPC(actors[i]);
        if (npc != nil) then
           local n = Entity.GetNode( AI.GetActor(npc) );

           node.SetPosition( n, pos[i].x, pos[i].y, pos[i].z );
           node.InvalidateTransforms( n , true );
        end
     end
     
     Level.ChangeGlobalState( 5 );
end

--------------------------------------------------------
-- Name: Level.OrderScript()
-- Desc:
--------------------------------------------------------
function Level.OrderScript()
   Level.RunAnchorJob3(AI.FindNPC('STAR'), 'A190', 'A234', 'A235', true);
   Level.RunAnchorJob(AI.FindNPC('SHES'), 'A191', false);
   Level.RunAnchorJob(AI.FindNPC('NIKO'), 'A192', false);
end

--------------------------------------------------------
-- Name: Level.BeginAlkogolicsScript()
-- Desc:
--------------------------------------------------------
  function Level.BeginAlkogolicsScript()
     Level.RunAnchorJob2(AI.FindNPC('SS79'), 'A216', 'A218');
     Level.RunAnchorJob2(AI.FindNPC('SS78'), 'A217', 'A219');
  end

--------------------------------------------------------
-- Name: Level.IsPlayerOfficer()
-- Desc:
--------------------------------------------------------
  function Level.IsPlayerOfficer()
     return AI.GetPlayerForm() == "Officer" or AI.GetPlayerForm() == "Major";
  end

--------------------------------------------------------
-- Name: Level.CanBeginAlkogolicsScript()
-- Desc:
--------------------------------------------------------
  function Level.CanBeginAlkogolicsScript()
     local npc1 = AI.FindNPC('SS78');
     local npc2 = AI.FindNPC('SS79');
     
     if (Level.IsPlayerOfficer() == false) then
         return false;
     end
     
     if (AI.IsDefault(npc1) == false or
         AI.IsDefault(npc2) == false) then
         return false;
     end
     
     if (AI.HasPlayerInfo( npc1, "see" ) == false and
         AI.HasPlayerInfo( npc2, "see" ) == false) then
        return false;
     end
     
     return true;
  end

--------------------------------------------------------
-- Name: Level.DoBrevnaScript_Physics()
-- Desc:
--------------------------------------------------------
  function Level.DoBrevnaScript_Physics()
     local brevna = { 'BR20',  'BR21',  'BR22',  'BR23',  'BR24',  'BR25' };
     local force  = { -8000.0, -0.0, -0.0, -300.0, -0.0, -1000.0 };
     
     Level.HideWorldObject('ROP2');
     Level.HideWorldObject('ROP3');
     
     for i in brevna do
        local brevno = Level.FindWorldObject(brevna[i]);
        if (brevno != nil) then
           Level.AddWorldObjectPhysicsForce(brevno, 0.0, 0.0, force[i] );
        else
           print("Can't find object: " .. brevna[i]);
        end
     end
  end

--------------------------------------------------------
-- Name: Level.DoBrevnaScript()
-- Desc:
--------------------------------------------------------
  function Level.DoBrevnaScript()
     Level.BrevnaRopeCutted = true;
     
     Level.DoBrevnaScript_Physics();
     Level.InstallDpc("Level.ExecuteSoldiersScript()", 0.9);
     
     AI.AddSoundFader('BRFD', "", 1519.24, -27.09, -1044.219, 150.0, 400.0);
     Level.InstallDpc("AI.RemoveSoundFader('BRFD')", 4.0);

     AI.AddScriptDynamicObstacle('BRV1', 1528.2184,-44.8584,-1057.5405,1551.0884,-34.8584,-1034.6385);
     AI.AddScriptDynamicObstacle('BRV2', 1472.1877,-43.4469,-1057.5405,1507.3898,-33.4469,-1034.6385);
     
     local npc = AI.FindNPC('NIKO');
     if (npc != nil and AI.IsScriptTask(npc) == true and Level.GlobalState >= 6) then
        Level.InstallDpc("AI.FailTask(AI.FindNPC('NIKO'), AI.TASK_SCRIPT_DEFAULT)", 1.0);
     end
  end

--------------------------------------------------------
-- Name: Level.HackAddPoisson()
-- Desc:
--------------------------------------------------------
  function Level.PlayerHasKnife()
     local numKnifes = Actor.GetNumWeaponOfClass( Level.GetPlayer(), Level.WEAPON_CLASS_KNIFE, true );
     return numKnifes >= 1;
  end

--------------------------------------------------------
-- Name: Level.DoBrevnaCutscene()
-- Desc:
--------------------------------------------------------
  function Level.DoBrevnaCutscene()
     Level.BeginCutScene("BrevnaCutscene", "Levels\\Otstupniki\\brevna.scm", "", 10.0, { 1, 0, 300.0, 500.0, 255 } )
  end

--------------------------------------------------------
-- Name: Level.ExecuteSoldiersScript()
-- Desc:
--------------------------------------------------------
  function Level.ExecuteSoldiersScript()
     local npcId    = { 'SS17', 'SS21', 'SS18', 'SS22', 'SS39', 'SS42', 'SS41' };
     local anchorId = { 'A222', 'A220', 'A221', 'A223', 'A224', 'A225', 'A226' };
     
     for i in npcId do
         if (i != Level.RunForDoctorNpcId) then
            local npc = AI.FindNPC(npcId[i]);
            if npc != nil then
               if (AI.IsScriptTask(npc) == false) then
                  Level.RunAnchorJob_Run(npc, anchorId[i], true);
               end
            end
         end
     end
  end

--------------------------------------------------------
-- Name: Level.DoBoatScript()
-- Desc:
--------------------------------------------------------
  function Level.DoBoatScript()
     Level.BoatRopeCutted = true;
     
     local boat = Level.FindWorldObject('BOAT');
     if (boat != nil) then
        Level.EnableWorldObjectPhysics( boat );
     else
        print("Warning: Can't find object 'BOAT'");
     end
     
     local objects = {  };
     for i in objects do
        Level.EnableWorldObjectPhysics( Level.FindWorldObject(objects[i]) );
     end
     
     -- Hide boat rope...
     Level.HideWorldObject('ROPE');
     
     AI.AddScriptDynamicObstacle('BOAT', 793.0762,-44.6433,126.5995,819.6971,-21.2923,173.3185);
     
     Level.InstallDpc( "Level.PlayCustomSound('BoatCrash')", 0.7 );
     --Level.PlayCustomSound('TorpedaCrash');
  end

--------------------------------------------------------
-- Name: Level.OnHitSurfaceBullet()
-- Desc:
--------------------------------------------------------
  function Level.OnHitSurfaceBullet( object, uniqueId, surface, px, py, pz )
     if (uniqueId == 'ROPE') then
        Level.BoatRopeBulletHitted = true;
        
        Level.DoBoatScript();
     elseif (uniqueId == 'ROP2') then
        Level.BrevnaRopeBulletHitted = true;
        
        Level.DoBrevnaScript();
     end
  end

--------------------------------------------------------
-- Name: Level.ActivateSaunaScript()
-- Desc:
--------------------------------------------------------
  function Level.ActivateSaunaScript()
     local npc = AI.FindNPC(Level.SaunaSpyNpcId);
     if (npc != nil) then
        Level.RunAnchorJob2_Run(npc, 'A227', 'A232', true);
     end
  end

--------------------------------------------------------
-- Name: Level.CheckSaunaScript()
-- Desc:
--------------------------------------------------------
  function Level.CheckSaunaScript()
     local npc = AI.FindNPC(Level.SaunaSpyNpcId);
     if (npc != nil) then
        if (Level.IsAtBBox( {483.0078, -43.9988, 539.5818, 501.0078, -23.9988, 557.5818}, 
                             Level.GetNpcPosition(npc) ) == true) then
 
           -- Activate sauna script...
           Level.ActivateSaunaScript();
           
           -- TODO... Play sound :)
        end
     end
  end

--------------------------------------------------------
-- Name: Level.DoVedroScript()
-- Desc:
--------------------------------------------------------
  function Level.DoVedroScript()
     if (Level.VedroScriptDone == true) then
        return;
     end
     
     Level.HideWorldObject('VDRO');
     Level.ShowWorldObject('VDR2');
     
     local vedro = Level.FindWorldObject('VDR2');
     if (vedro != nil) then
        AI.AddSoundFader('VEDR', "", 494.293701, -42.642315, 545.812378, 150.0, 400.0);
        Level.InstallDpc("AI.RemoveSoundFader('VEDR')", 10.0);
        
        Level.AddWorldObjectPhysicsForce(vedro, 0.0, 0.0, -1500.0 );
     else
        print("Can't find vedro");
     end
     
     Level.InstallDpc("Level.CheckSaunaScript()", 1.0);
     
     Level.VedroScriptDone = true;
  end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor232()
-- Desc:
--------------------------------------------------------
  function Level.OnAnchor_AIAnchor232()
     local npc = AI.FindNPC(Level.SaunaSpyNpcId);
     if (npc != nil) then
        local properties = Level.CreateCustomParams();

        Level.SetValue(properties, "CustomString_1", 'A229' );
        Level.SetValue(properties, "CustomString_2", 'A230' );
        Level.SetValue(properties, "CustomString_3", 'A228' );
        Level.SetValue(properties, "CustomString_4", 'A229' );
        Level.SetValue(properties, "CustomString_5", 'A230' );
           
        AI.RunScriptTask(npc, "scripts:job\\AnchorJob5_safe.lua", AI.LOGIC_DEFAULT, properties);
     end
  end

--------------------------------------------------------
-- Name: Level.OnAnchor_SetupAIAnchor232()
-- Desc:
--------------------------------------------------------
  function Level.OnAnchor_SetupAIAnchor232()
     Level.SpyAtSauna = true;
     Level.CloseDoor( Level.FindDoor('SNDR'), true, Level.GetPlayer() );
     Level.InstallDpc("Level.CheckSpyAtSauna()", 160.0);
  end

--------------------------------------------------------
-- Name: Level.CheckSpyAtSauna()
-- Desc: Player can lock sauna door using vehicle...
--------------------------------------------------------
  function Level.CheckSpyAtSauna()
     local vaid = { 'VA48', 'VA49', 'VA50' };
     local npc = AI.FindNPC(Level.SaunaSpyNpcId);
     
     if (npc != nil) then
        local npcRoom = AI.GetRoom(npc);
        
        for i in vaid do
           local room = Level.GetRoom(vaid[i]);
           if (room == npcRoom) then
             
             Level.KillSaunaSpy();
             return;
           end
        end
     end
  end

--------------------------------------------------------
-- Name: Level.KillSaunaSpy()
-- Desc:
--------------------------------------------------------
  function Level.KillSaunaSpy()
     local npc = AI.FindNPC(Level.SaunaSpyNpcId);
     if (npc != nil) then
        Level.RunAnchorJob_Run(npc, 'A233', true);

        AI.SetGameFlag(npc, AI.F_ACCIDENT_BODY, true);
        AI.KillNPC( npc, 10.0, AI.HIT_DAMAGE );
     end
  end

--------------------------------------------------------
-- Name: Level.CloseSaunaDoor()
-- Desc:
--------------------------------------------------------
  function Level.CloseSaunaDoor(bClose)
  
     if (bClose != false) then
        AI.AddScriptDynamicObstacle('SNDR', 355.5524, -38.9860 - 5.0, 981.6056, 370.3586, -14.5819, 983.8243);
     
        Level.SaunaDoorLocked = true;
     
        local door = Level.FindDoor('SNDR');
        if (door != nil) then
           Level.SetDoorUnlockKey(door, "deadlock");
           AI.RegisterClosedDoor( door, true );
        end
     
        if (Level.SpyAtSauna == true) then
           -- Kill spy
           Level.InstallDpc("Level.KillSaunaSpy()", 10.0);
        end
        
        Level.SetWorldObjectAnimFrame( Level.FindWorldObject('SNDR'), 30.0 );
        
     else
        Level.SaunaDoorLocked = false;
        
        local door = Level.FindDoor('SNDR');
        if (door != nil) then
           AI.RegisterClosedDoor( door, true );
           -- Level.SetDoorUnlockKey(door, 'KEY1');
        end
        
        AI.RemoveScriptDynamicObstacle('SNDR');
     end
  end

--------------------------------------------------------
-- Name: Level.ShowCaptainDocs()
-- Desc:
--------------------------------------------------------
  function Level.ShowCaptainDocs()
     -- Level.AddPlayerAction('CPAS', MissionText.Message_ShowCaptainDocs, "Level", false );
     Level.SafeAddLevelPlayerAction('CPAS', MissionText.Message_ShowCaptainDocs );
  end

--------------------------------------------------------
-- Name: Level.ShowCaptainDocs2()
-- Desc:
--------------------------------------------------------
  function Level.ShowCaptainDocs2()
     -- Level.AddPlayerAction('CPAS', MissionText.Message_ShowCaptainDocs, "Level", false );
     Level.SafeAddLevelPlayerAction('CPAS', MissionText.Message_ShowCaptainDocs );
  end

--------------------------------------------------------
-- Name: Level.CanShowCaptainDocs()
-- Desc:
--------------------------------------------------------
  function Level.CanShowCaptainDocs()
     local npc = AI.FindNPC('SO16');
     if (AI.IsDefault(npc) == false and AI.IsScriptTask(npc) == false) then
        return false;
     end
     
     if (AI.GetPlayerForm() == "Civilian") then
        return false;
     end
     
     if (Level.CaptainDocsScriptCompleted == true) then
        return false;
     end
     
     if (AI.HasPlayerInfo( npc, "see" ) == false) then
        return false;
     end
     
     return true;
  end

--------------------------------------------------------
-- Name: Level.OnShowCaptainDocs()
-- Desc:
--------------------------------------------------------
  function Level.OnShowCaptainDocs()
     local officer = AI.FindNPC('SO16');
     
     if (officer != nil) then
        AI.HandleVoice(officer, "");
        AI.SetJob(officer, "wait");
        Level.RunAnchorJob2(officer, 'A259', 'A260', true);
     end
  end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor260()
-- Desc:
--------------------------------------------------------
  function Level.OnAnchor_AIAnchor260()
    local npcId    = { 'SS89', 'SS87', 'SS86', 'SS88' };
    local anchorId = { 'A263', 'A264', 'A265', nil };
    
    for i in npcId do
       local npc = AI.FindNPC(npcId[i]);

       NPC.StartEvent( npc, NPC.EVENT_STOP_CUSTOM_ANIMATION );
       
       AI.SetJob(npc, "wait");
       if (anchorId[i] != nil) then
          Level.RunAnchorJob(npc, anchorId[i]);
       end
    end
  end

--------------------------------------------------------
-- Name: Level.ProcessBodyAccident()
-- Desc:
--------------------------------------------------------
  function Level.ProcessBodyAccident( npc, body )
     local id = Entity.GetUniqueIDAsString(body);
     
     if (Level.DoctorAccidentAnchor[id] == nil) then
        return;
     end
     
     if (Level.GetIndex(Level.GlobalScenaryNpc, id) == -1 and
         Level.GetIndex(Level.SpyNpc, id) == -1) then
         
         return;
      end
     
     local info = Level.GetDeadBodyInfo(body);
     if (info.accident == false) then
        return;
     end
     
     if (Level.InvestigatedAccident[id] == nil) then
        Level.RunForDoctorNpcId = AI.GetUID(npc);
        Level.RunAnchorJob_Run(npc, 'A269', true);
        Level.InvestigatedAccident[id] = false;
        
        if (Level.RunForDoctorNpcId != nil and Level.RunForDoctorNpcId != "") then
           if (AI.GetForm(npc) != "Civilian") then
              Level.InstallDpc("AI.HandleVoice(AI.FindNPC(Level.RunForDoctorNpcId), 'male_rus_script_script_66')", 0.2);
           else
              Level.InstallDpc("AI.HandleVoice(AI.FindNPC(Level.RunForDoctorNpcId), 'male_rus_script_script_67')", 0.2);
           end
        else
           if (AI.GetForm(npc) != "Civilian") then
              AI.HandleVoice(npc, 'male_rus_script_script_66');
           else
              AI.HandleVoice(npc, 'male_rus_script_script_67');
           end
        end
        
        Level.VoiceMessage(npc, nil, "Message_ForDoctor", 300.0);
     end
  end
  
  function Level.Test()
     AI.HandleVoice(AI.FindNPC(Level.RunForDoctorNpcId), 'male_rus_script_script_67');
  end

--------------------------------------------------------
-- Name: Level.ProcessDiversantBody()
-- Desc:
--------------------------------------------------------
  function Level.ProcessDiversantBody( npc, body )
     local bodyId = Entity.GetUniqueIDAsString(body);
     local npcId = AI.GetUID(npc);
     
     if (Level.GetIndex(Level.GlobalScenaryNpc, bodyId) == -1 and
         Level.GetIndex(Level.SpyNpc, bodyId) == -1) then
         
         return;
      end
      
     if (Level.GetIndex(Level.GlobalScenaryNpc, npcId) == -1 and
         Level.GetIndex(Level.SpyNpc, npcId) == -1) then
         
         return;
      end

     local info = Level.GetDeadBodyInfo(body);
     if (info.accident == true) then
        return;
     end
     
     Level.OnFailedMission( MissionText.Failed_Body );
  end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor260()
-- Desc:
--------------------------------------------------------
  function Level.OnSeeBody( npc, body )
     Level.ProcessBodyAccident( npc, body );
     Level.ProcessDiversantBody( npc, body );
  end
  
--------------------------------------------------------
-- Name: Level.OnSeePlayer_Group1()
-- Desc:
--------------------------------------------------------
  function Level.OnSeePlayer_Group1()
     if (Level.GlobalState < 3) then
        Level.OnFailedMission( MissionText.Failed_See );
     end
  end

--------------------------------------------------------
-- Name: Level.OnSeePlayer_Group2()
-- Desc:
--------------------------------------------------------
  function Level.OnSeePlayer_Group2()
     if ( Level.GlobalState >= 0 and
          (Level.SpyState < 3 or Level.IsDiversionCompleted() == false) ) then
        Level.OnFailedMission( MissionText.Failed_KillGroup2 );
     end
  end

--------------------------------------------------------
-- Name: Level.DisableVehicles()
-- Desc:
--------------------------------------------------------
  function Level.DisableVehicles( bOnOff )
     for i in Level.Vehicles do
        Level.EnableVehicleUse(Level.Vehicles[i], not bOnOff);
     end
  end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor274()
-- Desc:
--------------------------------------------------------
  function Level.OnAnchor_AIAnchor274()
     for i in Level.SpyNpc do
        AI.ClearMemory( AI.FindNPC(Level.SpyNpc[i]) );
     end
  end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor275()
-- Desc:
--------------------------------------------------------
  function Level.OnAnchor_AIAnchor275()
     for i in Level.SpyNpc do
        AI.ClearMemory( AI.FindNPC(Level.SpyNpc[i]) );
     end
  end

--------------------------------------------------------
-- Name: Level.IsDiversionCompleted()
-- Desc:
--------------------------------------------------------
  function Level.IsDiversionCompleted()
     for i in Level.DynamiteFusedState do
        if (Level.DynamiteFusedState[i] == "nofused") then
           return false;
        end
     end
     
     return true;
  end

--------------------------------------------------------
-- Name: Level.OnHitGroup1()
-- Desc:
--------------------------------------------------------
  function Level.OnNeutGroup1()
     if (Level.GlobalState < 3) then
        Level.OnFailedMission( MissionText.Failed_Kill );
        return false;
     end
     
     return true;
  end

--------------------------------------------------------
-- Name: Level.OnKillNikolaev()
-- Desc:
--------------------------------------------------------
  function Level.OnKillNikolaev()
     if (Level.OnNeutGroup1() == false) then
        return;
     end
     
     Level.FinishTask('NIKO');
  end

--------------------------------------------------------
-- Name: Level.OnHitNikolaev()
-- Desc:
--------------------------------------------------------
  function Level.OnHitNikolaev()
     if (Level.OnNeutGroup1() == false) then
        return;
     end
     
     Level.FinishTask('NIKO');
  end

--------------------------------------------------------
-- Name: Level.OnKillStarikov()
-- Desc:
--------------------------------------------------------
  function Level.OnKillStarikov()
     Level.OnFailedMission( MissionText.Failed_StarikovDead );
  end

--------------------------------------------------------
-- Name: Level.OnHitStarikov()
-- Desc:
--------------------------------------------------------
  function Level.OnHitStarikov()
     if (Level.OnNeutGroup1() == false) then
        return;
     end
     
     Level.FinishTask('STAR');
  end

--------------------------------------------------------
-- Name: Level.OnKillShestakov()
-- Desc:
--------------------------------------------------------
  function Level.OnKillShestakov()
     if (Level.SaunaDoorLocked == true) then
        Level.CloseSaunaDoor( false );
     end

     if (Level.OnNeutGroup1() == false) then
        return;
     end
     
     Level.FinishTask('SHES');
  end
  
--------------------------------------------------------
-- Name: Level.OnHitShestakov()
-- Desc:
--------------------------------------------------------
  function Level.OnHitShestakov()
     if (Level.SaunaDoorLocked == true) then
        Level.CloseSaunaDoor( false );
     end
     
     if (Level.OnNeutGroup1() == false) then
        return;
     end
     
     Level.FinishTask('SHES');     
  end

--------------------------------------------------------
-- Name: Level.IsSpyNpc()
-- Desc:
--------------------------------------------------------
  function Level.IsSpyNpc(npc)
     for i in Level.SpyNpc do
        if (npc == AI.FindNPC(Level.SpyNpc[i])) then
           return true;
        end
     end
     
     return false;
  end

--------------------------------------------------------
-- Name: Level.OnChangedAttention()
-- Desc:
--------------------------------------------------------
  function Level.OnChangedAttention(npc, attention)
     if ( Level.GlobalState < 4 ) then
        Level.OnFailedMission( MissionText.Failed_Attention );
        return;
     end
     
     if (Level.GlobalState < 6) then
        if (attention == AI.ATTENTION_ALARM) then
           Level.OnFailedMission( MissionText.Failed_Attention );
        end
     end
     
     if (Level.GlobalState > 4) then
        if (Level.IsSpyNpc(npc) and Level.IsDiversionCompleted() == false) then
           Level.OnFailedMission( MissionText.Failed_Attention );
           return;
        end
     end
  end

--------------------------------------------------------
-- Name: Level.OnGroup1_BodyInfo()
-- Desc:
--------------------------------------------------------
  function Level.OnGroup1_BodyInfo( npcId, body )
     if (Level.GlobalState < 6) then
        Level.ProcessDiversantBody( AI.FindNPC(npcId), body );
     end
  end

--------------------------------------------------------
-- Name: Level.OnGroup1_BodyInfo_STAR()
-- Desc:
--------------------------------------------------------
  function Level.OnGroup1_BodyInfo_STAR( body )
     Level.OnGroup1_BodyInfo('STAR');
  end

--------------------------------------------------------
-- Name: Level.OnGroup1_BodyInfo_NIKO()
-- Desc:
--------------------------------------------------------
  function Level.OnGroup1_BodyInfo_NIKO( body )
     Level.OnGroup1_BodyInfo('NIKO');
  end

--------------------------------------------------------
-- Name: Level.OnGroup1_BodyInfo_SHES()
-- Desc:
--------------------------------------------------------
  function Level.OnGroup1_BodyInfo_SHES( body )
     Level.OnGroup1_BodyInfo('NIKO');
  end

--------------------------------------------------------
-- Name: Level.OnNeut_Group2()
-- Desc:
--------------------------------------------------------
  function Level.OnNeut_Group2()
     Level.OnFailedMission( MissionText.Failed_KillGroup2 );
  end

--------------------------------------------------------
-- Name: Level.UpdateFormState()
-- Desc:
--------------------------------------------------------
  function Level.UpdateFormState()
    if (Level.GlobalState < 3) then
       for i in Level.GlobalScenaryNpc do
         AI.DecamouflagePlayer( AI.FindNPC(Level.GlobalScenaryNpc[i]), false );
       end
    else
       if (Level.IsDiversionCompleted() == false) then
          for i in Level.SpyNpc do
             AI.DecamouflagePlayer( AI.FindNPC(Level.SpyNpc[i]), false );
          end
       end
    end
    
    if (AI.GetPlayerForm() == "Major") then
       Level.SetHiGitlerAnim( "Act_Stand_ArmyHi", 5.0, "male_rus_script_script_71");
    elseif (AI.GetPlayerForm() == "Officer") then
       Level.SetHiGitlerAnim( "Act_Stand_ArmyHi", 5.0, "male_rus_script_script_72");       
    end    
  end

--------------------------------------------------------
-- Name: Level.OnChangeCloth()
-- Desc:
--------------------------------------------------------
  function Level.OnChangeCloth()
     Level.InstallDpc("Level.UpdateFormState()", 0.5);
     Level.InstallDpc("Level.UpdateFormState()", 1.0);
     Level.InstallDpc("Level.UpdateFormState()", 1.5);
     
     local npc = AI.GetFollowingPlayer();
     if (npc != nil) then
        AI.FailTask(npc, AI.TASK_FOLLOW_ACTOR);
     end
  end

--------------------------------------------------------
-- Name: Level.OnChangeCloth_Officer()
-- Desc:
--------------------------------------------------------
  function Level.OnChangeCloth_Officer()
     if (Level.GetDifficulty() < 2) then
        if (Level.NearStartPoint == true) then
           Level.AddSmallMessage( MissionText.Message_FormInfo, 10.0, 255, 255, 255 );
        end
     end
     
     local player = Level.GetPlayer();
     if ( player != nil ) then
        Actor.EnableMesh( player, "sabg_equipment_up"   , false );
        Actor.EnableMesh( player, "sabg_equipment_down" , false );
        Actor.EnableMesh( player, "mesh_helmet"         , false );
        Actor.EnableMesh( player, "mesh_shoulder"       , false );
        Actor.EnableMesh( player, "mesh_cap"            , true );
        
        Actor.SetSkin( player, 0 );
     end
     
     --Level.EnableLevelMark('FORM', false);
  end
  
--------------------------------------------------------
-- Name: Level.OnChangeCloth_Soldier()
-- Desc:
--------------------------------------------------------
  function Level.OnChangeCloth_Soldier()
     local player = Level.GetPlayer();
     if ( player != nil ) then
        Actor.EnableMesh( player, "sabg_equipment_up"   , false );
        Actor.EnableMesh( player, "sabg_equipment_down" , false );
        Actor.EnableMesh( player, "mesh_helmet"         , false );
        Actor.EnableMesh( player, "mesh_shoulder"        , false );
        Actor.EnableMesh( player, "mesh_cap"             , true );
        
        Actor.SetSkin( player, 0 );
     end
  end  

--------------------------------------------------------
-- Name: Level.OnChangeCloth_Ded()
-- Desc:
--------------------------------------------------------
  function Level.OnChangeCloth_Ded()
     local player = Level.GetPlayer();
     if ( player != nil ) then
        Actor.EnableMesh( player, "sabg_equipment_up"   , false );
        Actor.EnableMesh( player, "sabg_equipment_down" , false );
        Actor.EnableMesh( player, "mesh_helmet"         , false );
        Actor.EnableMesh( player, "mesh_shoulder"        , false );
        Actor.EnableMesh( player, "mesh_cap"             , true );
        
        Actor.SetSkin( player, 0 );
     end
  end  
  
--------------------------------------------------------
-- Name: Level.IsAllDynamitesCompleted()
-- Desc:
--------------------------------------------------------
  function Level.IsAllDynamitesCompleted()
    for i in Level.DynamiteFusedState do
       if (Level.DynamiteFusedState[i] != "completed") then
          return false;
       end
    end
    
    return true;
  end

--------------------------------------------------------
-- Name: Level.UnMineDynamite()
-- Desc:
--------------------------------------------------------
  function Level.UnMineDynamite(dynamiteId)
     if (Level.DynamiteFusedState[dynamiteId] == "fused") then
        Level.DynamiteFusedState[dynamiteId] = "completed";
        
        local dynamite = Level.FindWeaponItem( dynamiteId );
        if (dynamite != nil) then
           Entity.SetHidden( dynamite, true );
        else
           print("Can't find dynamite: " .. dynamiteId);
        end

        Level.EnableLevelMark(dynamiteId, false);

        if ( dynamiteId == 'DYN2' ) then
          Level.EnableSound( "tik_2" , false );         
        elseif ( dynamiteId == 'DYN1' ) then
          Level.EnableSound( "tik_1" , false );      
        elseif ( dynamiteId == 'DYN3' ) then
          Level.EnableSound( "tik_3" , false );      
        elseif ( dynamiteId == 'DYN4' ) then
          Level.EnableSound( "tik_4" , false );
        end;
        
        if (Level.IsAllDynamitesCompleted() == true) then
           Level.FinishTask('DIVE');
        end
     end
  end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor25()
-- Desc:
--------------------------------------------------------
  function Level.OnAnchor_AIAnchor25()
       local actor = Level.FindActor('STAR');
       if (actor != nil) then
          local docs = Level.CreateItem( "Custom" , "Equipment" );

          Entity.SetUniqueID( docs, 'PLAN' );

          Level.SetCustomItemName( docs, MissionText.Message_PlanNameL );
          Level.SetCustomItemIcon( docs, "ammo_doc" );

          Actor.PutPouch( actor, Actor.GetEmptyPouch( actor ), docs );
       end;
  end
  
--------------------------------------------------------
-- Name: Level.OnActorKilled()
-- Desc:
--------------------------------------------------------
function Level.OnActorKilled( actor )
   local info = Level.GetDeadBodyInfo(actor);
   if (info == nil) then
      return;
   end
   
   if (info.accident == true) then
      return;
   end
   
   local npc = AI.FromActor ( actor );
   if (npc != nil) then
      local form = AI.GetForm( npc );
      
      if (form != "SpyGroup1" and
          form != "SpyGroup2" and
          form != "SpyGroup1_Fast") then          
         Level.OnFailedMission( MissionText.Failed_SovietKilled );
      end
   end
end  

--------------------------------------------------------
-- Name: Level.OnFailedMission()
-- Desc:
--------------------------------------------------------
function Level.OnFailedMission(message)
   if (Level.HackNoFailMission == true) then
      return;
   end
   
   Level.FailedMission( message, 15.0 );
end

--------------------------------------------------------
-- Name: Level.CheckPlayerAtSarai()
-- Desc:
--------------------------------------------------------
function Level.CheckPlayerAtSarai()
   local npc = AI.FindNPC('SHES');
   
   if (npc == nil) then
      return true;
   end

   if (AI.HasTask(npc, AI.TASK_SCRIPT_DEFAULT) == false and
       AI.IsScriptTask(npc) == false) then
      return true; 
   end
   
   if (AI.HasPlayerInfo(npc, "see") == false) then
       return false;
   end
   
   local room_1 = Level.GetRoom('VA83');
   local room_2 = Level.GetRoom('VA84');
   local playerRoom = AI.GetPlayerRoom();
           
   if (playerRoom == room_1 or playerRoom == room_2) then
      return true;               
   end
   
   return false;
end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor204()
-- Desc:
--------------------------------------------------------
function Level.OnAnchor_AIAnchor204()
   if (Level.CheckPlayerAtSarai() == true) then
      return;
   end
   
   local npc = AI.FindNPC('SHES');
   
   AI.TaskCommand(npc, "current_anchor_completed", "", "");
   -- Level.RunAnchorJob2(npc, 'A279', 'A199', true);
   local properties = Level.CreateCustomParams();

   Level.SetValue(properties, "CustomString_1", 'A279' );
   Level.SetValue(properties, "CustomString_2", 'A199' );

   AI.RunScriptTask(npc, "scripts:job\\AnchorJob2_safe_breakable.lua", AI.LOGIC_DEFAULT, properties);
   
   if (Level.GetDifficulty() != 0) then
      Level.InstallSingleSmartDpc("AI.FailTask(AI.FindNPC('SHES'), AI.TASK_SCRIPT_DEFAULT)", 1.0, "Level.CheckPlayerAtSarai()");
   end
end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor205()
-- Desc:
--------------------------------------------------------
function Level.OnAnchor_AIAnchor205()
   Level.RemoveDpc("AI.FailTask(AI.FindNPC('SHES'), AI.TASK_SCRIPT_DEFAULT)");
end

--------------------------------------------------------
-- Name: Level.NeedEnableMark()
-- Desc:
--------------------------------------------------------
function Level.NeedEnableMark( markId )
   if (markId == 'SARA') then
      return Level.IsMissionTaskCompleted('SHES') == false and
             Level.BoatRopeCutted == false;
   elseif (markId == 'BREV') then
      return Level.IsMissionTaskCompleted('NIKO') == false and
             Level.BrevnaRopeCutted == false;
   elseif (markId == 'SCDT') then
      return Level.CaptainDocsScriptCompleted == false and
             AI.GetPlayerForm() != "Civilian";
   elseif (markId == 'VEDR') then
      return Level.VedroScriptDone == false and
             Level.GetDifficulty() <= 1;
   end
end

--------------------------------------------------------
-- Name: Level.OnCheckSpyGroupVision()
-- Desc:
--------------------------------------------------------
function Level.OnCheckSpyGroupVision()
  
   -- 0 - default
   -- 1 - first try
   -- 2 - fast decamouflage

   for i in Level.GlobalScenaryNpc do
      local id = Level.GlobalScenaryNpc[i];
      local npc = AI.FindNPC(id);
      
      if (Level.LockVisionNotify[id] == false and
          Level.PlayerDecamouflageState[id] != 2) then
         
--         print(AI.HasPlayerInfo( npc, "see" ));
--         print(AI.IsDefault(npc));
         
         --local goodTask = AI.IsDefault(npc) == true or AI.IsScriptTask(npc) == true;
         local goodTask = (AI.IsDefault(npc) == true);        
        
         if (goodTask == true and AI.HasPlayerInfo( npc, "see" ) == true ) then
        
            local playerPos = Level.GetPlayerPosition();
            local npcPos    = Level.GetNpcPosition(npc);
            local room      = AI.GetRoom(npc);
            
            if (room == -1) then

               local distance = Level.BalanceDistance(playerPos, npcPos);

               if (distance < 60.0) then

                  local properties = Level.CreateCustomParams();

                  if (random() < 0.5) then
                     Level.SetValue(properties, "CustomString_1", "Relaxed_Talk_Scratch1:male_rus_script_script_82" );
                  else
                     Level.SetValue(properties, "CustomString_1", "Relaxed_Talk_Scratch1:male_rus_script_script_83" );
                  end
                  
                  Level.SetValue(properties, "CustomString_2", "4.5" );
                  Level.SetValue(properties, "CustomString_3", "" );

                  AI.RunScriptTask(npc, "scripts:job\\PlayerAnimTask.lua", AI.LOGIC_DEFAULT, properties);

                  Level.PlayerDecamouflageState[id] = Level.PlayerDecamouflageState[id] + 1;

                  AI.SetDecamouflageTimeCoeff(npc, 0.0);

                  local newCoeff = 1.0;
                  if (Level.PlayerDecamouflageState[id] == 2) then
                     newCoeff = 2.5;
                  end

                  if (Level.PlayerDecamouflageState[id] == 1) then
                     AI.SetForm(npc, "SpyGroup1_Fast");
                  end

                  local command = "AI.SetDecamouflageTimeCoeff(AI.FindNPC('" .. id .. "'), " .. tostring(newCoeff) .. ")";
                  Level.InstallDpc(command, 5.0);

                  Level.LockVisionNotify[id] = true;

                  Level.InstallDpc("Level.LockVisionNotify['" .. id .. "'] = false", 60.0);

                  -- cutscene...
                  local cameraName = "Levels\\Otstupniki\\dynamic.scm";
                  local cs = Level.BeginCutScene("DynamicSpy", cameraName, "", 3.0, { 1, 0, 300.0, 500.0, 255 } );
   
                  local npcPos    = Level.GetNpcPosition( npc );
                  local pos = { };

                  pos.x = npcPos.x + (-16.657695);
                  pos.y = npcPos.y + 64.169975;
                  pos.z = npcPos.z + (-20.969325);
  
                  CutScene.SetCameraParam(cs, cameraName, "pos" , pos.x, pos.y, pos.z );               
               end
            end
         end
      end
   end
end

--------------------------------------------------------
-- Name: Level.OnStartUseBinocular()
-- Desc:
--------------------------------------------------------
function Level.OnStartUseBinocular()
   local messages = {"", MissionText.Message_CutScene_Binocular};
   
   Level.BeginCutScene("BinocularCutscene", "Levels\\Otstupniki\\binocular.scm", messages, 9.0, { 1, 0.0, 1500.0, 2500.0, 255 } );   
   
   Level.VoiceMessage(AI.FindNPC('SPY2'), nil, 'Message_Binocular');
   Level.InstallDpc("Level.PlayCustomSound('Script04_Sound')", 0.1);
end

--------------------------------------------------------
-- Name: Level.OnTrigger_SimpleTrigger50()
-- Desc:
--------------------------------------------------------
function Level.OnTrigger_SimpleTrigger50()
   Level.RunAnchorJob(AI.FindNPC('S118'), 'A284');
end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor_A259()
-- Desc:
--------------------------------------------------------
function Level.OnAnchor_AIAnchor_A259()
   Level.VoiceMessage(AI.FindNPC('SO16'), "%Script14_Sound", "Message_OkWeWillGo");
end

--------------------------------------------------------
-- Name: Level.OnAnchor_AIAnchor_A259()
-- Desc:
--------------------------------------------------------
function Level.OnTrigger_SimpleTrigger51()
   local npc = AI.FindNPC('SO16');
   if (AI.IsDefault(npc) == true) then
      Level.RunAnchorJob(npc, 'A285', false);
   end
end

--------------------------------------------------------
-- Name: Level.HackTestStoneReaction()
-- Desc:
--------------------------------------------------------
function Level.HackTestStoneReaction()
    for i in Level.GlobalScenaryNpc do
       local npc = AI.FindNPC(Level.GlobalScenaryNpc[i]);
       AI.Disable(npc, "stone_reaction");
    end
end

--------------------------------------------------------
-- Name: Level.OnTransformStats_CheckDiversant()
-- Desc:
--------------------------------------------------------
function Level.OnTransformStats_CheckDiversant( levelStats, id )
   if (Level.IsMissionTaskCompleted(id) == true) then
   
      local info = Level.GetDeadBodyInfo(Level.FindActor(id));
      if (info != nil) then
         if (info.accident == true) then
            return;
         end
      end
   
      if (Actor.IsHitted(Level.FindActor(id)) == true) then
         Level.DecrementLevelStats(levelStats, "NumEnemiesStuned");
      else
         Level.DecrementLevelStats(levelStats, "NumEnemiesKilled");
      end
   end
end

--------------------------------------------------------
-- Name: Level.OnTransformStats()
-- Desc:
--------------------------------------------------------
function Level.OnTransformStats(levelStats, aiStats)
   Level.OnTransformStats_CheckDiversant(levelStats, 'NIKO');
   Level.OnTransformStats_CheckDiversant(levelStats, 'STAR');
   Level.OnTransformStats_CheckDiversant(levelStats, 'SHES');
   
   if (Level.BoatRopeBulletHitted == true) then
      Level.IncrementLevelStats(levelStats, "NumBulletsHited");
   end

   if (Level.BrevnaRopeBulletHitted == true) then
      Level.IncrementLevelStats(levelStats, "NumBulletsHited");
   end
end

--------------------------------------------------------
-- Name: Level.OnTransformStats()
-- Desc:
--------------------------------------------------------
function Level.OnTransformInputs(levelStats, aiStats, a, c, p, n, acc)
   c = c * 2.5;
   n = n * 0.9;

   p = Level.DefaultCalcProf(c, n, acc);
  
   local info = Level.GetDeadBodyInfo(Level.FindActor('NIKO'));
   if (info != nil) then
      if (info.accident == true) then
         p = p + 0.1;
      end
   end
   
   local info = Level.GetDeadBodyInfo(Level.FindActor('SHES'));
   if (info != nil) then
      if (info.accident == true) then
         p = p + 0.1;
      end
   end
   
   if (Level.IsMissionTaskCompleted('MEET') == false) then
      p = p - 0.15;
   end
   
   return a, c, p, n;
end

--------------------------------------------------------
-- Name: Level.OnCalcScore()
-- Desc:
--------------------------------------------------------
function Level.OnCalcRateScore(rank, score, levelStats, aiStats, a, c, p, n, acc)
   if (rank == 7) then
      rank = 6;
   end
   
   return rank, score;
end


----------------------- Debug methods ----------------------------------------